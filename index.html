<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scotiabank | Dashboard de Calidad</title>
  <link rel="icon" href="https://www.scotiabank.com/content/dam/scotiabank/corporate/images/favicon.ico">
  <script src="https://cdn.jsdelivr.net/npm/chart.js">
  // VARIABLE GLOBAL PARA ALMACENAR DATOS FILTRADOS
  var currentFilteredData = [];

  function updateFeedbackFilters(){
    var ejecutivo = document.getElementById('feedbackEjecutivoFilter').value;
    var selCamp = document.getElementById('feedbackCampanaFilter');
    var selSup = document.getElementById('feedbackSupervisorFilter');
    var selFecha = document.getElementById('feedbackFechaFilter');

    // Si no hay ejecutivo, reiniciar todo
    if(!ejecutivo){
        selCamp.innerHTML = '<option value="">Todas las campa√±as</option>';
        selSup.innerHTML = '<option value="">Todos los supervisores</option>';
        selFecha.innerHTML = '<option value="">Todas las fechas</option>';
        return;
    }

    // Filtrar datos base por ejecutivo
    var datosEjecutivo = [];
    if(typeof allData !== 'undefined'){
        datosEjecutivo = allData.filter(function(d){
            return d['Ejecutivo'] === ejecutivo;
        });
    }

    // Obtener Campa√±as, Supervisores y Fechas de este ejecutivo
    var campanas = {};
    var supervisores = {};
    var fechas = {};

    datosEjecutivo.forEach(function(d){
        if(d['Campa√±a']) campanas[d['Campa√±a']] = true;
        if(d['Supervisor']) supervisores[d['Supervisor']] = true;
        if(d['Fecha de Evaluaci√≥n']) fechas[d['Fecha de Evaluaci√≥n']] = true;
    });

    // Actualizar Select Campa√±a
    var campActual = selCamp.value;
    selCamp.innerHTML = '<option value="">Todas las campa√±as</option>';
    Object.keys(campanas).sort().forEach(function(c){
        var opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        selCamp.appendChild(opt);
    });
    // Intentar mantener selecci√≥n si existe en las nuevas opciones
    if(campanas[campActual]) selCamp.value = campActual;

    // Actualizar Select Supervisor
    var supActual = selSup.value;
    selSup.innerHTML = '<option value="">Todos los supervisores</option>';
    Object.keys(supervisores).sort().forEach(function(s){
        var opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        selSup.appendChild(opt);
    });
    if(supervisores[supActual]) selSup.value = supActual;

    // Actualizar Select Fecha
    var fechaActual = selFecha.value;
    selFecha.innerHTML = '<option value="">Todas las fechas</option>';
    Object.keys(fechas).sort().reverse().forEach(function(f){
        var opt = document.createElement('option');
        opt.value = f;
        opt.textContent = f;
        selFecha.appendChild(opt);
    });
    // Aqu√≠ es CLAVE: Si la fecha seleccionada antes sigue siendo v√°lida para este ejecutivo, mantenerla
    // Si no, resetear a "Todas las fechas"
    if(fechas[fechaActual]) selFecha.value = fechaActual;
  }

  // Modificar populateFeedbackFilters para asignar el evento correcto
  function populateFeedbackFilters(){
    var ejecutivos = {};

    if(typeof allData !== 'undefined'){
        allData.forEach(function(d){
            if(d['Ejecutivo']) ejecutivos[d['Ejecutivo']] = true;
        });
    }

    var selEjec = document.getElementById('feedbackEjecutivoFilter');
    if(selEjec){
        selEjec.innerHTML = '<option value="">Selecciona un ejecutivo...</option>';
        Object.keys(ejecutivos).sort().forEach(function(e){
            var opt = document.createElement('option');
            opt.value = e;
            opt.textContent = e;
            selEjec.appendChild(opt);
        });

        // ASIGNAR EL NUEVO LISTENER DE FILTRADO EN CADENA
        selEjec.removeEventListener('change', updateFechaFilter); // Remover viejo si existe
        selEjec.addEventListener('change', updateFeedbackFilters);
    }
  }


</script>
  <style>
    :root {
      --color-white: rgba(255, 255, 255, 1);
      --color-cream-50: rgba(252, 252, 249, 1);
      --color-cream-100: rgba(255, 255, 253, 1);
      --color-gray-200: rgba(245, 245, 245, 1);
      --color-gray-300: rgba(167, 169, 169, 1);
      --color-gray-400: rgba(119, 124, 124, 1);
      --color-slate-500: rgba(98, 108, 113, 1);
      --color-charcoal-700: rgba(31, 33, 33, 1);
      --color-charcoal-800: rgba(38, 40, 40, 1);
      --color-slate-900: rgba(19, 52, 59, 1);
      --color-teal-300: rgba(50, 184, 198, 1);
      --color-teal-400: rgba(45, 166, 178, 1);
      --color-teal-500: rgba(33, 128, 141, 1);
      --color-teal-600: rgba(29, 116, 128, 1);
      --color-red-400: rgba(255, 84, 89, 1);
      --color-red-500: rgba(192, 21, 47, 1);
      --color-orange-400: rgba(230, 129, 97, 1);

      --color-brown-600-rgb: 94, 82, 64;
      --color-teal-500-rgb: 33, 128, 141;
      --color-slate-900-rgb: 19, 52, 59;
      --color-red-400-rgb: 255, 84, 89;
      --color-gray-400-rgb: 119, 124, 124;

      --color-background: var(--color-cream-50);
      --color-surface: var(--color-cream-100);
      --color-text: var(--color-slate-900);
      --color-text-secondary: var(--color-slate-500);
      --color-primary: var(--color-teal-500);
      --color-primary-hover: var(--color-teal-600);
      --color-border: rgba(var(--color-brown-600-rgb), 0.2);
      --color-error: var(--color-red-500);
      --color-success: var(--color-teal-500);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --color-background: var(--color-charcoal-700);
        --color-surface: var(--color-charcoal-800);
        --color-text: var(--color-gray-200);
        --color-primary: var(--color-teal-300);
        --color-primary-hover: var(--color-teal-400);
        --color-border: rgba(var(--color-gray-400-rgb), 0.3);
        --color-error: var(--color-red-400);
      }
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--color-background);
      color: var(--color-text);
      padding: 20px;
      line-height: 1.6;
    }

    .container { max-width: 1400px; margin: 0 auto; }

    header {
      background: var(--color-surface);
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      border: 1px solid var(--color-border);
    }

    h1 { font-size: 28px; font-weight: 600; color: var(--color-text); margin-bottom: 8px; }
    .subtitle { color: var(--color-text-secondary); font-size: 14px; }

    .fecha-actual-box {
      background: linear-gradient(135deg, var(--color-primary), var(--color-teal-400));
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    .fecha-actual-box .fecha-label { font-size: 14px; opacity: 0.9; }
    .fecha-actual-box .fecha-valor { font-size: 24px; font-weight: 700; }

    .filter-section {
      background: var(--color-surface);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 24px;
      border: 1px solid var(--color-border);
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      align-items: end;
    }

    .filter-group { display: flex; flex-direction: column; gap: 6px; }
    .filter-label { font-size: 13px; font-weight: 500; color: var(--color-text); }

    .kpis-wrapper {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .kpis-section {
      background: var(--color-surface);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--color-border);
    }

    .kpis-section-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--color-primary);
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--color-border);
    }

    .kpis-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .kpis-grid.quiebres {
      grid-template-columns: repeat(2, 1fr);
    }

    .kpi-card {
      background: var(--color-background);
      padding: 16px;
      border-radius: 10px;
      border: 1px solid var(--color-border);
      text-align: center;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .kpi-label { font-size: 12px; color: var(--color-text-secondary); margin-bottom: 8px; font-weight: 600; line-height: 1.3; }
    .kpi-value { font-size: 28px; font-weight: 700; color: var(--color-primary); margin-bottom: 4px; }
    .kpi-subtitle { font-size: 11px; color: var(--color-text-secondary); }
    /* ESTILO ESPEC√çFICO PARA EL MOTIVO DE NO VENTA */
    .kpi-motivo { 
        font-size: 20px;
        color: #FFD700; /* Dorado para resaltar */
        margin-top: 8px; 
        font-weight: 900;
        line-height: 1.4;
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .active-filter {
      display: inline-block;
      padding: 3px 6px;
      background: var(--color-primary);
      color: white;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 500;
      margin-top: 6px;
    }

    .btn {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary { background: var(--color-primary); color: white; }
    .btn-primary:hover { background: var(--color-primary-hover); }
    .btn-secondary { background: var(--color-surface); color: var(--color-text); border: 1px solid var(--color-border); }
    .btn-sm { padding: 6px 12px; font-size: 12px; }

    .form-section {
      background: var(--color-surface);
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      border: 1px solid var(--color-border);
    }

    .form-section.collapsed { display: none; }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-label { font-size: 13px; font-weight: 500; color: var(--color-text); }

    .form-control {
      padding: 10px 12px;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      background: var(--color-background);
      color: var(--color-text);
      font-size: 14px;
    }

    .form-control:focus { outline: 2px solid var(--color-primary); outline-offset: 0; }
    textarea.form-control { min-height: 80px; resize: vertical; }
    .section-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--color-text); }

    .message { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; }
    .message-success { background: rgba(var(--color-teal-500-rgb), 0.1); color: var(--color-success); border: 1px solid rgba(var(--color-teal-500-rgb), 0.3); }
    .message-error { background: rgba(var(--color-red-400-rgb), 0.1); color: var(--color-error); border: 1px solid rgba(var(--color-red-400-rgb), 0.3); }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .chart-container {
      background: var(--color-surface);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--color-border);
      min-height: 300px;
    }

    .table-container {
      background: var(--color-surface);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--color-border);
      overflow-x: auto;
      margin-bottom: 24px;
    }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--color-border); font-size: 13px; }
    th { font-weight: 600; color: var(--color-text); background: var(--color-background); position: sticky; top: 0; z-index: 10; }

    .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; }
    .badge-success { background: rgba(var(--color-teal-500-rgb), 0.15); color: var(--color-success); }
    .badge-error { background: rgba(var(--color-red-400-rgb), 0.15); color: var(--color-error); }

    .search-box {
      padding: 10px 12px;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      width: 100%;
      max-width: 300px;
      margin-bottom: 16px;
      font-size: 14px;
      background: var(--color-background);
      color: var(--color-text);
    }

    .actions { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
    .loading { text-align: center; padding: 40px; color: var(--color-text-secondary); }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      animation: fadeIn 0.3s;
      overflow-y: auto;
      padding: 20px;
    }

    .modal.show { display: flex; align-items: center; justify-content: center; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .modal-content {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      padding: 24px;
      max-width: 600px;
      max-height: 85vh;
      overflow-y: auto;
      width: 100%;
      animation: slideIn 0.3s;
    }

    @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .modal-header {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--color-text);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: var(--color-text-secondary);
      padding: 8px;
      min-width: 44px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: background 0.2s;
    }

    .modal-close:hover { background: rgba(0,0,0,0.1); color: var(--color-text); }

    .detail-row { display: flex; padding: 12px 0; border-bottom: 1px solid var(--color-border); }
    .detail-row:last-child { border-bottom: none; }
    .detail-label { font-weight: 600; color: var(--color-primary); width: 40%; min-width: 150px; }
    .detail-value { flex: 1; color: var(--color-text); word-break: break-word; }

    .modal-footer {
      margin-top: 20px;
      text-align: center;
      padding-top: 16px;
      border-top: 1px solid var(--color-border);
    }

    .modal-footer .btn { min-width: 140px; min-height: 44px; font-size: 15px; }

    @media (max-width: 1200px) {
      .kpis-wrapper { grid-template-columns: 1fr; }
    }

    @media (max-width: 768px) {
      body { padding: 12px; }
      .modal-content { padding: 16px; }
      .filter-grid { grid-template-columns: 1fr 1fr; }
      .chart-container { min-height: 280px; }
      .kpis-grid.quiebres { grid-template-columns: 1fr; }
    }
  
    /* ESTILOS PARA PESTA√ëAS */
    .tabs-container {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
      border-bottom: 2px solid var(--color-border);
      padding-bottom: 0;
      flex-wrap: wrap;
    }

    .tab-button {
      padding: 14px 24px;
      border: none;
      background: transparent;
      color: var(--color-text-secondary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
      position: relative;
    }

    .tab-button:hover {
      color: var(--color-text);
    }

    .tab-button.active {
      color: var(--color-primary);
      border-bottom-color: var(--color-primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Estilos para Feedback */
    .feedback-section {
      background: var(--color-surface);
      padding: 30px;
      border-radius: 12px;
      border: 1px solid var(--color-border);
    }

    .feedback-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--color-text);
    }

    .feedback-subtitle {
      font-size: 14px;
      color: var(--color-text-secondary);
      margin-bottom: 24px;
    }

    .feedback-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .feedback-option {
      padding: 20px;
      border: 2px solid var(--color-border);
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: var(--color-background);
    }

    .feedback-option:hover {
      border-color: var(--color-primary);
      background: var(--color-surface);
      transform: translateY(-4px);
    }

    .feedback-option.selected {
      border-color: var(--color-primary);
      background: rgba(50, 184, 198, 0.1);
    }

    .feedback-option-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .feedback-option-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--color-text);
    }

    .feedback-form {
      background: var(--color-background);
      padding: 24px;
      border-radius: 10px;
      border: 1px solid var(--color-border);
    }

    .feedback-form-group {
      margin-bottom: 20px;
    }

    .feedback-form-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: 8px;
      display: block;
    }

    .feedback-form-input,
    .feedback-form-textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      background: var(--color-surface);
      color: var(--color-text);
      font-size: 14px;
      font-family: inherit;
    }

    .feedback-form-textarea {
      min-height: 120px;
      resize: vertical;
    }

    .feedback-form-input:focus,
    .feedback-form-textarea:focus {
      outline: 2px solid var(--color-primary);
      outline-offset: 0;
      border-color: var(--color-primary);
    }

    .feedback-submit-btn {
      background: var(--color-primary);
      color: white;
      padding: 12px 32px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
    }

    .feedback-submit-btn:hover {
      background: var(--color-primary-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(50, 184, 198, 0.3);
    }

  

/* === Layout con men√∫ lateral (Dashboard/Feedback) === */
.app-layout{
  display:grid;
  grid-template-columns: 160px 1fr;
  gap: 12px;               /* M√°s pegado al contenido */
  align-items: stretch;    /* Sidebar llega hasta abajo */
}
.sidebar{
  align-self: stretch;
  min-height: calc(100vh - 28px);
  background: rgba(33, 92, 179, 0.06); /* Azul claro suave */
  border: 1px solid rgba(33, 92, 179, 0.16);
  border-radius: 12px;
  padding: 10px;
}
.sidebar-header{
  font-size: 11px;
  font-weight: 900;
  color: rgba(33, 92, 179, 0.85);
  margin-bottom: 10px;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}
.sidebar-link{
  width: 100%;
  display:flex;
  align-items:center;
  gap: 8px;
  text-align: left;
  padding: 10px 10px;
  border-radius: 10px;
  border: 1px solid rgba(33, 92, 179, 0.18);
  background: rgba(255,255,255,0.55);
  color: var(--color-text);
  font-weight: 800;
  cursor: pointer;
  min-height: 42px;
  margin-bottom: 8px;
  transition: border-color .2s ease, background .2s ease, transform .1s ease;
}
.sidebar-link:hover{
  border-color: rgba(33, 92, 179, 0.45);
  background: rgba(33, 92, 179, 0.08);
}
.sidebar-link:active{ transform: translateY(1px); }
.sidebar-link.active{
  border-color: rgba(33, 92, 179, 0.75);
  color: rgba(33, 92, 179, 1);
  background: rgba(33, 92, 179, 0.12);
}
.sidebar-ico{
  width: 20px;
  height: 20px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-size: 15px;
}
.sidebar-text{ white-space: nowrap; }
.app-main{ min-width: 0; }

/* Ocultar las pesta√±as antiguas */
.tabs-container{ display:none !important; }

/* Ajuste de espaciado global (sin superponer) */
@media (min-width: 901px){
  body{ padding: 16px; }
}

/* Responsive */
@media (max-width: 900px){
  .app-layout{ grid-template-columns: 1fr; }
  .sidebar{
    min-height: auto;
    align-self: auto;
    display:flex;
    align-items:center;
    gap: 10px;
    flex-wrap:wrap;
  }
  .sidebar-link{ width:auto; margin: 0; }
}

@media (max-width: 420px){
  .sidebar-header{ width:100%; margin-bottom: 8px; }
  .sidebar-link{ width: 100%; justify-content:flex-start; }
}


/* Ajuste: 5 filtros de Feedback en una sola fila (desktop) */
#feedback .filter-section .filter-grid{
  grid-template-columns: repeat(5, minmax(140px, 1fr));
  gap: 10px;
}
#feedback .filter-section .filter-label{
  font-size: 12px;
}
#feedback .filter-section .form-control{
  padding: 8px 10px;
  font-size: 13px;
}
@media (max-width: 1100px){
  #feedback .filter-section .filter-grid{
    grid-template-columns: repeat(2, minmax(160px, 1fr));
  }
}
@media (max-width: 520px){
  #feedback .filter-section .filter-grid{
    grid-template-columns: 1fr;
  }
}


/* ===== Login overlay (Scotiabank Per√∫) ===== */
.login-overlay{
  position: fixed;
  inset: 0;
  background: radial-gradient(1200px 600px at 20% 10%, rgba(255,84,89,0.18), rgba(0,0,0,0) 55%),
              rgba(0,0,0,0.58);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2500;
  padding: 18px;
}
.login-overlay.hidden{ display:none; }

.login-card{
  width: 100%;
  max-width: 560px;
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: 16px;
  padding: 22px;
  box-shadow: 0 18px 70px rgba(0,0,0,0.42);
}

.login-brand{
  display:flex;
  align-items:center;
  justify-content:center;
  gap: 10px;
  margin-bottom: 10px;
}

.login-logo{
  width: 230px;
  max-width: 78%;
  height: auto;
  filter: drop-shadow(0 6px 14px rgba(0,0,0,0.25));
}

.login-tag{
  font-weight: 900;
  font-size: 11px;
  letter-spacing: 1.4px;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,84,89,0.35);
  background: rgba(255,84,89,0.10);
  color: var(--color-text);
}

.login-title{
  font-size: 18px;
  font-weight: 900;
  color: var(--color-text);
  margin-bottom: 6px;
  text-align: center;
}

.login-subtitle{
  font-size: 13px;
  color: var(--color-text-secondary);
  margin-bottom: 16px;
  text-align: center;
}

.login-grid{
  display:grid;
  grid-template-columns: 1fr;
  gap: 12px;
  margin-bottom: 10px;
}

@media (min-width: 560px){
  .login-grid{ grid-template-columns: 1fr 1fr; }
}

.login-group{ display:flex; flex-direction: column; gap: 6px; }

.login-label{
  font-size: 12px;
  font-weight: 800;
  color: var(--color-text-secondary);
}

.login-input{
  padding: 10px 12px;
  border: 1px solid var(--color-border);
  border-radius: 10px;
  background: var(--color-background);
  color: var(--color-text);
  font-size: 14px;
}

.login-input:focus{
  outline: 2px solid var(--color-primary);
  outline-offset: 0;
  border-color: var(--color-primary);
}

.login-actions{
  display:flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 12px;
  justify-content: center;
}

.login-msg{
  padding: 10px 12px;
  border-radius: 10px;
  font-size: 13px;
  margin-top: 8px;
  border: 1px solid rgba(239,68,68,0.35);
  background: rgba(239,68,68,0.10);
  color: var(--color-error);
}

.login-help{
  margin-top: 12px;
  padding: 12px;
  border-radius: 12px;
  border: 1px solid var(--color-border);
  background: var(--color-background);
  font-size: 12px;
  color: var(--color-text);
}

.login-foot{
  margin-top: 14px;
  font-size: 11px;
  color: var(--color-text-secondary);
  line-height: 1.4;
  text-align: center;
}

</style>
</head>
<body>

<!-- LOGIN OVERLAY (m√°scara de acceso UI) -->
<div id="loginOverlay" class="login-overlay" aria-hidden="false">
  <div class="login-card" role="dialog" aria-modal="true" aria-labelledby="loginTitle">

    <div class="login-brand">
      <img class="login-logo" src="https://commons.wikimedia.org/wiki/Special:FilePath/Scotiabank_logo.svg" alt="Scotiabank" />
      <div class="login-tag">PER√ö</div>
    </div>

    <div class="login-title" id="loginTitle">GESTI√ìN CALIDAD SCOTIABANK</div>
    <div class="login-subtitle">Acceso visual para uso interno. Ingresa usuario y contrase√±a.</div>

    <div class="login-grid">
      <div class="login-group">
        <label class="login-label" for="loginUser">Usuario</label>
        <input id="loginUser" class="login-input" type="text" placeholder="Ej: ops01" autocomplete="username" />
      </div>

      <div class="login-group">
        <label class="login-label" for="loginPass">Contrase√±a</label>
        <input id="loginPass" class="login-input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
      </div>
    </div>

    <div id="loginMsg" class="login-msg" style="display:none;"></div>

    <div class="login-actions">
      <button class="btn btn-primary" type="button" onclick="handleLogin()">Ingresar</button>
      <button class="btn btn-secondary" type="button" onclick="toggleLoginHelp()">¬øUsuarios?</button>
    </div>

    <div id="loginHelp" class="login-help" style="display:none;">
      <div style="font-weight:800; margin-bottom:6px;">Perfiles de acceso (editable)</div>
      <ul style="margin:0; padding-left:18px;">
        <li><b>Operaciones</b>: Dashboard, Feedback, An√°lisis.</li>
        <li><b>Calidad</b>: Gesti√≥n Calidad.</li>
      </ul>
      <div style="margin-top:8px; font-size:11px; color:var(--color-text-secondary);">Edita usuarios/clave en el bloque <code>USER_DB</code> del script.</div>
    </div>

    <div class="login-foot">
      Esta pantalla es una m√°scara UI (no reemplaza controles de acceso reales).
    </div>

  </div>
</div>

  <div class="app-layout">
  <aside class="sidebar" aria-label="Men√∫">
    <div class="sidebar-header">Men√∫</div>
<button class="sidebar-link" type="button" onclick="logout()"><span class="sidebar-ico" aria-hidden="true">üîí</span><span class="sidebar-text">Cerrar sesi√≥n</span></button>

      <button class="sidebar-link active" type="button" data-tab="dashboard" onclick="switchTab('dashboard')">
        <span class="sidebar-ico" aria-hidden="true"></span>
        <span class="sidebar-text">Dashboard</span>
      </button>

      <button class="sidebar-link" type="button" data-tab="feedback" onclick="switchTab('feedback')">
        <span class="sidebar-ico" aria-hidden="true"></span>
        <span class="sidebar-text">Feedback</span>
      </button>
<button class="sidebar-link" type="button" data-tab="analisis" onclick="switchTab('analisis')"><span class="sidebar-ico" aria-hidden="true">üìä</span><span class="sidebar-text">An√°lisis</span></button>
<button class="sidebar-link" type="button" data-tab="gestion" onclick="switchTab('gestion')">
        <span class="sidebar-ico" aria-hidden="true"></span>
        <span class="sidebar-text">Gesti√≥n Calidad</span>
      </button>
</aside>
  <main class="app-main">
<div class="container">
    <header>
      <h1>üìä Dashboard de Calidad - Scotiabank</h1>
      <p class="subtitle">Sistema de Auditor√≠a y Seguimiento de Llamadas</p>
      <div style="margin-top: 12px; padding: 8px 12px; background: rgba(50, 184, 198, 0.1); border-radius: 6px; font-size: 11px; color: var(--color-text-secondary);">
        üìå Versi√≥n 3.5 | <span id="lastUpdate">Actualizando...</span>
      </div>
    </header>

    <div class="fecha-actual-box">
      <div>
        <div class="fecha-label">üìÖ Fecha de Evaluaci√≥n</div>
        <div class="fecha-valor" id="fechaActual"></div>
      </div>
      <div style="text-align: right;">
        <div class="fecha-label">üïê Hora actual</div>
        <div class="fecha-valor" id="horaActual" style="font-size: 18px;"></div>
      </div>
    </div>

    
    <!-- SISTEMA DE PESTA√ëAS -->
    <div class="tabs-container">
      <button class="tab-button active" onclick="switchTab('dashboard')">üìä Dashboard</button>
      <button class="tab-button" onclick="switchTab('feedback')">üí¨ Feedback</button>
    </div>

    <!-- CONTENIDO DEL DASHBOARD (pesta√±a activa) -->
    <div id="dashboard" class="tab-content active">

    <div id="loadingMessage" class="loading">üîÑ Cargando datos desde Google Sheets...</div>
    <div id="messageContainer"></div>

    <div class="filter-section">
      <div class="filter-grid">
        <div class="filter-group">
          <label class="filter-label">üîç Filtrar por Ejecutivo</label>
          <select id="ejecutivoFilter" class="form-control" onchange="applyFilters()">
            <option value="">Todos los ejecutivos</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">üìã Filtrar por Campa√±a</label>
          <select id="campanaFilter" class="form-control" onchange="applyFilters()">
            <option value="">Todas las campa√±as</option>
            <option value="Pr√©stamos">Pr√©stamos</option>
            <option value="Deepening">Deepening</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">&nbsp;</label>
          <button class="btn btn-secondary" onclick="clearFilters()">üóëÔ∏è Limpiar Filtros</button>
        </div>
      </div>
    </div>

    <div class="kpis-wrapper" id="kpisContainer"></div>

    <div class="actions">
      
      <button class="btn btn-secondary" onclick="exportToCSV()">üì• Exportar a CSV</button>
    </div>

    

    <div class="charts-grid" id="chartsContainer"></div>

    <div class="table-container">
      <input type="text" class="search-box" placeholder="üîç Buscar..." oninput="filterTable(this.value)">
      <table>
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    </div>

    <!-- CONTENIDO DE FEEDBACK (pesta√±a oculta) -->
    
    <!-- CONTENIDO DE FEEDBACK (pesta√±a oculta) -->
    

    <!-- CONTENIDO DE GESTI√ìN CALIDAD -->
    <div id="gestion" class="tab-content">
      <div class="form-section" id="formSection">
      <h2 class="section-title">Nueva Auditor√≠a</h2>
      <form id="auditForm" onsubmit="submitForm(event)">
        <div class="section-title">Informaci√≥n B√°sica</div>
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Ejecutivo *</label>
            <input type="text" name="ejecutivo" class="form-control" required>
          </div>
          <div class="form-group">
            <label class="form-label">Supervisor *</label>
            <select name="supervisor" class="form-control" required>
              <option value="">Seleccionar...</option>
              <option value="Ivan Aguirre C√≥rdova">Ivan Aguirre C√≥rdova</option>
              <option value="Ronny Paliza Cabezas">Ronny Paliza Cabezas</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Campa√±a *</label>
            <select name="campana" class="form-control" required>
              <option value="">Seleccionar...</option>
              <option value="Deepening">Deepening</option>
              <option value="Pr√©stamos">Pr√©stamos</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Semana *</label>
            <select name="semana" class="form-control" required>
              <option value="">Seleccionar...</option>
              <option value="Semana 1">Semana 1</option>
              <option value="Semana 2">Semana 2</option>
              <option value="Semana 3">Semana 3</option>
              <option value="Semana 4">Semana 4</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Fecha y Hora de llamada *</label>
            <input type="text" name="fechaHora" class="form-control" placeholder="Ej: 2025-11-28 14:30" required>
          </div>
          <div class="form-group">
            <label class="form-label">Tel√©fono evaluado *</label>
            <input type="text" name="telefono" class="form-control" required>
          </div>
          <div class="form-group">
            <label class="form-label">Tipo de Llamada *</label>
            <select name="tipoLlamada" class="form-control" required>
              <option value="">Seleccionar...</option>
              <option value="Venta">Venta</option>
              <option value="No Venta">No Venta</option>
            </select>
          </div>
        </div>

        <div class="section-title">Evaluaci√≥n de Habilidades Comerciales</div>
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Sondeo</label>
            <select name="sondeo" class="form-control">
              <option value="NA">NA</option>
              <option value="SI">SI</option>
              <option value="NO">NO</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Rebate</label>
            <select name="rebate" class="form-control">
              <option value="NA">NA</option>
              <option value="SI">SI</option>
              <option value="NO">NO</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Genera Necesidad</label>
            <select name="generaNecesidad" class="form-control">
              <option value="NA">NA</option>
              <option value="SI">SI</option>
              <option value="NO">NO</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Cierre de Venta</label>
            <select name="cierreVenta" class="form-control">
              <option value="NA">NA</option>
              <option value="SI">SI</option>
              <option value="NO">NO</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Usa Baja</label>
            <select name="usaBaja" class="form-control">
              <option value="NA">NA</option>
              <option value="SI">SI</option>
              <option value="NO">NO</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Habilidad comercial</label>
            <select name="habilidadComercial" class="form-control">
              <option value="NA">NA</option>
              <option value="SI">SI</option>
              <option value="NO">NO</option>
            </select>
          </div>
        </div>

        <div class="section-title">Informaci√≥n de No Venta</div>
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Motivo No Venta</label>
            <select name="motivoNoVenta" class="form-control">
              <option value="No usa TC">No usa TC</option>
              <option value="% de TEA, TCEA elevado">% de TEA, TCEA elevado</option>
              <option value="L√≠nea de cr√©dito ofrecida no es atractiva para cliente">L√≠nea de cr√©dito no atractiva</option>
              <option value="Cliente no presenta deudas, no tiene donde invertir">Cliente sin deudas</option>
              <option value="Mala experiencia con el banco">Mala experiencia con el banco</option>
              <option value="Tiene muchas TC">Tiene muchas TC</option>
              <option value="Llamada agendada">Llamada agendada</option>
              <option value="Cliente reacio, no da chance a explicaci√≥n">Cliente reacio</option>
              <option value="Desea acercarse a la agencia">Desea acercarse a la agencia</option>
              <option value="Gesti√≥n del agente no es la adecuada">Gesti√≥n inadecuada</option>
              <option value="Venta realizada">Venta realizada</option>
              <option value="Cliente corta llamada sin motivo">Cliente corta llamada</option>
              <option value="Cliente no indica motivo concreto">Cliente no indica motivo concreto</option>
              <option value="Cliente no tiene donde invertir/usar el producto.">Cliente no tiene donde invertir/usar el producto.</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Responsabilidad</label>
            <select name="responsabilidad" class="form-control">
              <option value="N/A">N/A</option>
              <option value="Agente">Agente</option>
              <option value="Banco">Banco</option>
              <option value="Cliente">Cliente</option>
            </select>
          </div>
        </div>

        <div class="section-title">Observaciones</div>
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Observaciones Positivas *</label>
            <textarea name="observacionesPositivas" class="form-control" required></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Observaciones Mejora *</label>
            <textarea name="observacionesMejora" class="form-control" required></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Recomendaciones *</label>
            <textarea name="recomendaciones" class="form-control" required></textarea>
          </div>
        </div>

        <div class="section-title">Audio de la Llamada</div>
        <div class="form-grid">
          <div class="form-group" style="grid-column: 1 / -1;">
            <label class="form-label">üîä Enlace de Audio (Google Drive)</label>
            <input type="text" name="audio" class="form-control" placeholder="https://drive.google.com/file/d/...">
            <small style="color: var(--color-text-secondary); margin-top: 4px; display: block;">Pega el enlace compartido de Google Drive (opcional)</small>
          </div>
        </div>

        <div class="actions">
          <button type="submit" class="btn btn-primary">üíæ Guardar Auditor√≠a</button>
          <button type="button" class="btn btn-secondary" onclick="toggleForm()">Cancelar</button>
        </div>
      </form>
    </div>
    </div>

<div id="analisis" class="tab-content">
  <div class="kpis-section" style="margin-bottom: 16px;">
    <div class="kpis-section-title">An√°lisis de auditor√≠as (ventas telef√≥nicas)</div>
    <div style="font-size: 13px; color: var(--color-text-secondary);">
      Hallazgos accionables basados en los filtros actuales del Dashboard (Ejecutivo/Campa√±a).
    </div>
  </div>

  <div class="kpis-wrapper" id="analysisKpis"></div>

  <div class="charts-grid" id="analysisCharts">
  <div class="chart-container"><canvas id="analysisChart1"></canvas></div>
  <div class="chart-container"><canvas id="analysisChart2"></canvas></div>
  <div class="chart-container"><canvas id="analysisChart3"></canvas></div>
  <div class="chart-container"><canvas id="analysisChart4"></canvas></div>
  <div class="chart-container"><canvas id="analysisChart5"></canvas></div>
  <div class="chart-container"><canvas id="analysisChart6"></canvas></div>
</div>

  <div class="table-container" style="margin-top: 24px;">
    <div style="display:flex; justify-content: space-between; align-items:center; gap:12px; flex-wrap:wrap;">
      <div style="font-weight:700; color: var(--color-primary);">Narrativa y acciones sugeridas</div>
      <button class="btn btn-secondary btn-sm" type="button" onclick="renderAnalysis()">Actualizar an√°lisis</button>
    </div>
    <div id="analysisNarrative" style="margin-top: 12px; color: var(--color-text); font-size: 13px; line-height: 1.6;"></div>
  </div>
</div>
<div id="feedback" class="tab-content">
      <div class="feedback-section">
        <h2 class="feedback-title">üìù Feedback y Observaciones</h2>
        <p class="feedback-subtitle">Consulta las observaciones positivas y oportunidades de mejora por ejecutivo.</p>

        
        <!-- Filtros para Feedback -->
        <div class="filter-section" style="margin-bottom: 24px;">
            <div class="filter-grid">
                <!-- Filtro Ejecutivo -->
                <div class="filter-group">
                    <label class="filter-label">üë§ Ejecutivo</label>
                    <select id="feedbackEjecutivoFilter" class="form-control" onchange="renderFeedbackView()">
                        <option value="">Selecciona un ejecutivo...</option>
                    </select>
                </div>
                <!-- Filtro Campa√±a (Nuevo) -->
                <div class="filter-group">
                    <label class="filter-label">üìã Campa√±a</label>
                    <select id="feedbackCampanaFilter" class="form-control" onchange="renderFeedbackView()">
                        <option value="">Todas las campa√±as</option>
                        <option value="Pr√©stamos">Pr√©stamos</option>
                        <option value="Deepening">Deepening</option>
                    </select>
                </div>
                <!-- Filtro Supervisor (Nuevo) -->
                <div class="filter-group">
                    <label class="filter-label">üëÅÔ∏è Supervisor</label>
                    <select id="feedbackSupervisorFilter" class="form-control" onchange="renderFeedbackView()">
                        <option value="">Todos los supervisores</option>
                        <option value="Ivan Aguirre C√≥rdova">Ivan Aguirre C√≥rdova</option>
                        <option value="Ronny Paliza Cabezas">Ronny Paliza Cabezas</option>
                    </select>
                </div>
            
                <!-- Filtro Fecha -->
                <div class="filter-group">
                    <label class="filter-label">üìÖ Fecha de Evaluaci√≥n</label>
                    <select id="feedbackFechaFilter" class="form-control" onchange="renderFeedbackView()">
                        <option value="">Todas las fechas</option>
                    </select>
                
                </div>

                <!-- Filtro Tel√©fono (NUEVO) -->
                <div class="filter-group">
                    <label class="filter-label">‚òéÔ∏è Tel√©fono</label>
                    <select id="feedbackTelefonoFilter" class="form-control" onchange="renderFeedbackView()">
                        <option value="">Todos los tel√©fonos</option>
                    </select>
                </div>
</div>
        </div>

        
        <!-- Barra de Acciones -->
        <div id="feedbackDisplay" style="margin-top: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--color-surface); border-radius: 8px; border: 1px solid var(--color-border);">
                <button class="btn btn-primary" onclick="cargarObservaciones()" style="background-color: var(--color-primary); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                    üëÅÔ∏è VER
                </button>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 600; color: var(--color-text);">
                        <input type="checkbox" id="feedbackRealizadoCheck" style="width: 20px; height: 20px; cursor: pointer;">
                        <span>‚úÖ FEEDBACK REALIZADO</span>
                    </label>
                </div>
            </div>
        </div>

<!-- Contenedor de Observaciones -->
        <div id="feedbackDisplay" style="display: none;">
            <div class="feedback-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">

                <!-- Tarjeta Positiva -->
                <div class="feedback-card positive">
                    <div class="feedback-header positive">
                        <span class="feedback-icon">üåü</span> Observaciones Positivas
                    </div>
                    <div id="positiveContainer" class="feedback-list">
                        <!-- Items se insertan aqu√≠ -->
                    </div>
                </div>

                <!-- Tarjeta Mejora -->
                <div class="feedback-card improvement">
                    <div class="feedback-header improvement">
                        <span class="feedback-icon">üöÄ</span> Oportunidades de Mejora
                    </div>
                    <div id="improvementContainer" class="feedback-list">
                        <!-- Items se insertan aqu√≠ -->
                    </div>
                </div>

            </div>
        </div>

        <div id="feedbackEmptyState" style="text-align: center; padding: 40px; color: var(--color-text-secondary);">
            Selecciona un ejecutivo para ver sus observaciones.
        </div>
      </div>
    </div>


  </div>

  <div id="detailModal" class="modal" onclick="if(event.target===this) closeModal()">
    <div class="modal-content">
      <div class="modal-header">
        <span>üìã Detalles de Auditor√≠a</span>
        <button class="modal-close" onclick="closeModal()">‚úï</button>
      </div>
      <div id="modalBody"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">‚úï Cerrar</button>
      </div>
    </div>
  </div>

  
    <!-- MODAL DETALLES FEEDBACK -->
    <div id="feedbackDetailModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: var(--color-surface); border-radius: 12px; max-width: 1000px; max-height: 90vh; overflow-y: auto; padding: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.3); width: 90%;">
            <div style="padding: 24px; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; background: var(--color-background);">
                <h2 id="feedbackDetailTitle" style="margin: 0; font-size: 18px; font-weight: 700; color: var(--color-text);">Detalles del Feedback</h2>
                <button onclick="cerrarFeedbackModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--color-text-secondary);">‚úï</button>
            </div>
            <div style="padding: 24px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Tarjeta Positiva -->
                    <div style="border: 1px solid #10b981; border-radius: 8px; overflow: hidden;">
                        <div style="background: rgba(16, 185, 129, 0.1); color: #10b981; padding: 12px; font-weight: bold; display: flex; align-items: center; gap: 8px;">
                            <span>üåü</span> Observaciones Positivas
                        </div>
                        <div id="positiveContainer" style="padding: 16px; max-height: 400px; overflow-y: auto;"></div>
                    </div>
                    <!-- Tarjeta Mejora -->
                    <div style="border: 1px solid #ef4444; border-radius: 8px; overflow: hidden;">
                        <div style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 12px; font-weight: bold; display: flex; align-items: center; gap: 8px;">
                            <span>üöÄ</span> Oportunidades de Mejora
                        </div>
                        <div id="improvementContainer" style="padding: 16px; max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    var GOOGLE_SHEETS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTR4TBW_qQtsV-yHeyv_EJhixz5qW1AFxXyWLZYxEa95MrUWiqrLrpJuVdFAPmtFKUnvtQ1mO0muhNq/pub?gid=0&single=true&output=csv';
    var GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwcYSCuNukl4XLzGDhG5iAvmuvcAZjuD7IYSglifnGa2HSdx3GY3aBI_Gwx5o16XEa6og/exec';

    var allData = [];
    var filteredData = [];
    var currentEjecutivo = '';
    var currentCampana = '';
    var searchQuery = '';
    var chartInstances = [];
    var autoRefreshInterval = null;

    function actualizarFechaHora() {
      var ahora = new Date();
      var opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      var fechaFormateada = ahora.toLocaleDateString('es-PE', opciones);
      fechaFormateada = fechaFormateada.charAt(0).toUpperCase() + fechaFormateada.slice(1);

      var horas = ahora.getHours().toString().padStart(2, '0');
      var minutos = ahora.getMinutes().toString().padStart(2, '0');
      var segundos = ahora.getSeconds().toString().padStart(2, '0');

      document.getElementById('fechaActual').textContent = fechaFormateada;
      document.getElementById('horaActual').textContent = horas + ':' + minutos + ':' + segundos;
    }

    setInterval(actualizarFechaHora, 1000);
    actualizarFechaHora();

    function startAutoRefresh() {
      if (autoRefreshInterval) clearInterval(autoRefreshInterval);
      autoRefreshInterval = setInterval(function() {
        loadDataFromGoogleSheets(true);
      }, 15000);
    }

    function loadDataFromGoogleSheets(silent) {
      var timestamp = new Date().getTime();
      var urlConTimestamp = GOOGLE_SHEETS_CSV_URL + '&t=' + timestamp;

      if (!silent) {
        document.getElementById('loadingMessage').style.display = 'block';
      }

      fetch(urlConTimestamp)
        .then(function(response) {
          if (!response.ok) throw new Error('Error de red: ' + response.status);
          return response.text();
        })
        .then(function(csvText) {
          var parsed = parseCSV(csvText);

          if (parsed.length > 1) {
            var headers = parsed[0];
            allData = parsed.slice(1).filter(function(row) {
              return row.some(function(cell) { return cell.trim(); });
            }).map(function(row) {
              var obj = {};
              headers.forEach(function(header, idx) {
                obj[header.trim()] = (row[idx] || '').trim();
              });
              return obj;
            });
          } else {
            allData = [];
          }

          document.getElementById('loadingMessage').style.display = 'none';
          populateEjecutivoFilter();
          applyFilters();

          var now = new Date();
          document.getElementById('lastUpdate').textContent = '√öltima actualizaci√≥n: ' + now.toLocaleTimeString('es-PE');

          if (!silent) {
            showMessage('‚úì Datos actualizados: ' + allData.length + ' registros', 'success');
          }
        })
        .catch(function(error) {
          document.getElementById('loadingMessage').style.display = 'none';
          if (!silent) {
            showMessage('‚ö†Ô∏è Error al actualizar datos.', 'error');
          }
        });
    }

    function parseCSV(text) {
      var lines = text.split('\n').filter(function(line) { return line.trim(); });
      return lines.map(function(line) {
        var values = [];
        var current = '';
        var inQuotes = false;

        for (var i = 0; i < line.length; i++) {
          var char = line[i];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            values.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        values.push(current.trim());
        return values;
      });
    }

    function populateEjecutivoFilter() {
      var ejecutivosSet = {};
      allData.forEach(function(d) {
        if (d['Ejecutivo']) ejecutivosSet[d['Ejecutivo']] = true;
      });
      var ejecutivos = Object.keys(ejecutivosSet).sort();

      var select = document.getElementById('ejecutivoFilter');
      var currentValue = select.value;
      select.innerHTML = '<option value="">Todos los ejecutivos</option>';
      ejecutivos.forEach(function(ej) {
        var option = document.createElement('option');
        option.value = ej;
        option.textContent = ej;
        if (ej === currentValue) option.selected = true;
        select.appendChild(option);
      });
    }

    function applyFilters() {
      currentEjecutivo = document.getElementById('ejecutivoFilter').value;
      currentCampana = document.getElementById('campanaFilter').value;

      filteredData = allData.filter(function(d) {
        var matchEjecutivo = !currentEjecutivo || d['Ejecutivo'] === currentEjecutivo;
        var matchCampana = !currentCampana || d['Campa√±a'] === currentCampana;
        var matchSearch = !searchQuery || Object.values(d).some(function(val) {
          return String(val).toLowerCase().indexOf(searchQuery) !== -1;
        });
        return matchEjecutivo && matchCampana && matchSearch;
      });

      renderDashboard();
    }

    function clearFilters() {
      document.getElementById('ejecutivoFilter').value = '';
      document.getElementById('campanaFilter').value = '';
      currentEjecutivo = '';
      currentCampana = '';
      searchQuery = '';
      document.querySelector('.search-box').value = '';
      filteredData = allData.slice();
      renderDashboard();
    }

    function renderDashboard() {
      renderKPIs();
      renderCharts();
      renderTable();
    }

    function renderKPIs() {
      var total = filteredData.length;

      var quiebresHabilidad = filteredData.filter(function(d) { return d['Habilidad comercial'] === 'NO'; }).length;
      var pctHabilidad = total > 0 ? Math.round((quiebresHabilidad / total) * 100) : 0;

      var quiebresSondeo = filteredData.filter(function(d) { return d['Sondeo'] === 'NO'; }).length;
      var pctSondeo = total > 0 ? Math.round((quiebresSondeo / total) * 100) : 0;

      var quiebresRebate = filteredData.filter(function(d) { return d['Rebate'] === 'NO'; }).length;
      var pctRebate = total > 0 ? Math.round((quiebresRebate / total) * 100) : 0;

      var quiebresNecesidad = filteredData.filter(function(d) { return d['Genera Necesidad'] === 'NO'; }).length;
      var pctNecesidad = total > 0 ? Math.round((quiebresNecesidad / total) * 100) : 0;

      var motivosData = {};
      filteredData.forEach(function(d) {
        var motivo = d['Motivo No Venta'] || 'N/A';
        motivosData[motivo] = (motivosData[motivo] || 0) + 1;
      });
      var mayorMotivo = 'N/A';
      var mayorCantidad = 0;
      for (var motivo in motivosData) {
        if (motivosData[motivo] > mayorCantidad) {
          mayorCantidad = motivosData[motivo];
          mayorMotivo = motivo;
        }
      }
      var motivoTotal = Object.values(motivosData).reduce(function(a, b) { return a + b; }, 0);
      var pctMotivo = motivoTotal > 0 ? Math.round((mayorCantidad / motivoTotal) * 100) : 0;

      var filterTags = '';
      if (currentEjecutivo) filterTags += '<span class="active-filter">' + currentEjecutivo + '</span>';
      if (currentCampana) filterTags += '<span class="active-filter">' + currentCampana + '</span>';

      var html = 
        '<div class="kpis-section">' +
          '<div class="kpis-section-title">üìä Total de Auditor√≠as</div>' +
          '<div class="kpis-grid">' +
            '<div class="kpi-card">' +
              '<div class="kpi-label">Total de Evaluaciones</div>' +
              '<div class="kpi-value">' + total + '</div>' +
              '<div class="kpi-subtitle">evaluaciones' + (filterTags ? '<br>' + filterTags : '') + '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="kpis-section">' +
          '<div class="kpis-section-title">‚ö†Ô∏è Quiebres Habilidades Comerciales</div>' +
          '<div class="kpis-grid quiebres">' +
            '<div class="kpi-card">' +
              '<div class="kpi-label">% Quiebre Habilidad Comercial</div>' +
              '<div class="kpi-value">' + pctHabilidad + '%</div>' +
              '<div class="kpi-subtitle">' + quiebresHabilidad + ' evaluaciones</div>' +
            '</div>' +
            '<div class="kpi-card">' +
              '<div class="kpi-label">% Quiebre Sondeo</div>' +
              '<div class="kpi-value">' + pctSondeo + '%</div>' +
              '<div class="kpi-subtitle">' + quiebresSondeo + ' evaluaciones</div>' +
            '</div>' +
            '<div class="kpi-card">' +
              '<div class="kpi-label">% Quiebre Rebate</div>' +
              '<div class="kpi-value">' + pctRebate + '%</div>' +
              '<div class="kpi-subtitle">' + quiebresRebate + ' evaluaciones</div>' +
            '</div>' +
            '<div class="kpi-card">' +
              '<div class="kpi-label">% Quiebre Genera Necesidad</div>' +
              '<div class="kpi-value">' + pctNecesidad + '%</div>' +
              '<div class="kpi-subtitle">' + quiebresNecesidad + ' evaluaciones</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="kpis-section">' +
          '<div class="kpis-section-title">üéØ Mayor Motivo de No Venta</div>' +
          '<div class="kpis-grid">' +
            '<div class="kpi-card">' +
              '<div class="kpi-label">Motivo M√°s Frecuente</div>' +
              '<div class="kpi-value">' + pctMotivo + '%</div>' +
              '<div class="kpi-subtitle">' + mayorCantidad + ' llamadas</div>' +
              '<div class="kpi-motivo">' + mayorMotivo + '</div>' +
            '</div>' +
          '</div>' +
        '</div>';

      document.getElementById('kpisContainer').innerHTML = html;
    }

    function renderCharts() {
      chartInstances.forEach(function(chart) { chart.destroy(); });
      chartInstances = [];
      var container = document.getElementById('chartsContainer');
      container.innerHTML = 
        '<div class="chart-container"><canvas id="chart1"></canvas></div>' +
        '<div class="chart-container"><canvas id="chart2"></canvas></div>' +
        '<div class="chart-container"><canvas id="chart3"></canvas></div>' +
        '<div class="chart-container"><canvas id="chart4"></canvas></div>' +
        '<div class="chart-container"><canvas id="chart5"></canvas></div>';
      if (filteredData.length === 0) return;

      var habilidadData = countValues(filteredData, 'Habilidad comercial');
      chartInstances.push(new Chart(document.getElementById('chart1'), {
        type: 'doughnut',
        data: {
          labels: Object.keys(habilidadData),
          datasets: [{ data: Object.values(habilidadData), backgroundColor: ['#32B8C6', '#FF5459', '#A7A9A9'] }]
        },
        options: { responsive: true, plugins: { title: { display: true, text: 'Habilidad Comercial' }, legend: { position: 'bottom' } } }
      }));

      var tipoData = countValues(filteredData, 'Tipo de Llamada');
      chartInstances.push(new Chart(document.getElementById('chart2'), {
        type: 'bar',
        data: { labels: Object.keys(tipoData), datasets: [{ label: 'Cantidad', data: Object.values(tipoData), backgroundColor: '#32B8C6' }] },
        options: { responsive: true, plugins: { title: { display: true, text: 'Tipo de Llamada' }, legend: { display: false } } }
      }));

      var campanaData = countValues(filteredData, 'Campa√±a');
      chartInstances.push(new Chart(document.getElementById('chart3'), {
        type: 'pie',
        data: { labels: Object.keys(campanaData), datasets: [{ data: Object.values(campanaData), backgroundColor: ['#32B8C6', '#F59E0B'] }] },
        options: { responsive: true, plugins: { title: { display: true, text: 'Distribuci√≥n por Campa√±a' }, legend: { position: 'bottom' } } }
      }));

      var motivoData = countValues(filteredData, 'Motivo No Venta');
      var motivoTotal = Object.values(motivoData).reduce(function(a, b) { return a + b; }, 0);
      var motivoLabels = Object.keys(motivoData).map(function(label) {
        var pct = motivoTotal > 0 ? Math.round((motivoData[label] / motivoTotal) * 100) : 0;
        return label.substring(0, 25) + (label.length > 25 ? '...' : '') + ' (' + pct + '%)';
      });
      chartInstances.push(new Chart(document.getElementById('chart4'), {
        type: 'bar',
        data: { labels: motivoLabels, datasets: [{ label: 'Cantidad', data: Object.values(motivoData), backgroundColor: '#FF6B6B' }] },
        options: { responsive: true, indexAxis: 'y', plugins: { title: { display: true, text: '% Motivo de No Venta' }, legend: { display: false } }, scales: { x: { beginAtZero: true } } }
      }));

      var responsabilidadData = countValues(filteredData, 'Responsabilidad');
      var respTotal = Object.values(responsabilidadData).reduce(function(a, b) { return a + b; }, 0);
      var respLabels = Object.keys(responsabilidadData).map(function(label) {
        var pct = respTotal > 0 ? Math.round((responsabilidadData[label] / respTotal) * 100) : 0;
        return label + ' (' + pct + '%)';
      });
      chartInstances.push(new Chart(document.getElementById('chart5'), {
        type: 'doughnut',
        data: { labels: respLabels, datasets: [{ data: Object.values(responsabilidadData), backgroundColor: ['#00C49F', '#FFBB28', '#FF8042', '#A7A9A9'] }] },
        options: { responsive: true, plugins: { title: { display: true, text: '% Responsabilidad No Venta' }, legend: { position: 'bottom' } } }
      }));
    }

    function countValues(data, key) {
      var counts = {};
      data.forEach(function(row) {
        var val = row[key] || 'N/A';
        counts[val] = (counts[val] || 0) + 1;
      });
      return counts;
    }

    function renderTable() {
      if (filteredData.length === 0) {
        document.getElementById('tableHead').innerHTML = '<tr><th>No hay datos disponibles</th></tr>';
        document.getElementById('tableBody').innerHTML = '';
        return;
      }
      var visibleHeaders = ['Ejecutivo', 'Supervisor', 'Campa√±a', 'Tipo de Llamada', 'Fecha de Evaluaci√≥n'];
      document.getElementById('tableHead').innerHTML = '<tr>' + visibleHeaders.map(function(h) { return '<th>' + h + '</th>'; }).join('') + '<th>Acci√≥n</th></tr>';
      var rows = filteredData.map(function(row, idx) {
        return '<tr>' + visibleHeaders.map(function(h) {
          var value = row[h] || '';
          if (value === 'SI') value = '<span class="badge badge-success">SI</span>';
          if (value === 'NO') value = '<span class="badge badge-error">NO</span>';
          return '<td>' + value + '</td>';
        }).join('') + '<td><button class="btn btn-secondary btn-sm" onclick="showDetail(' + idx + ')">üëÅÔ∏è VER</button></td></tr>';
      }).join('');
      document.getElementById('tableBody').innerHTML = rows;
    }

    function showDetail(index) {
      var row = filteredData[index];
      var headers = Object.keys(row);
      var html = '';

      headers.forEach(function(header) {
        var value = row[header] || '';

        if ((header === 'Audio' || header === 'audio') && value && value.trim()) {
          if (value.includes('drive.google.com')) {
            var driveId = '';
            var match = value.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (match) driveId = match[1];
            if (!driveId) {
              match = value.match(/id=([a-zA-Z0-9-_]+)/);
              if (match) driveId = match[1];
            }

            if (driveId) {
              value = '<div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">' +
                      '<a href="https://drive.google.com/file/d/' + driveId + '/preview" target="_blank" style="text-decoration:none; padding:10px 16px; background:#32B8C6; color:white; border-radius:6px; font-size:13px;">‚ñ∂ Escuchar</a>' +
                      '<a href="https://drive.google.com/uc?export=download&id=' + driveId + '" target="_blank" style="text-decoration:none; padding:10px 16px; background:#2d5a67; color:white; border-radius:6px; font-size:13px;">üì• Descargar</a>' +
                      '</div>';
            }
          }
        } else {
          if (value === 'SI') value = '<span class="badge badge-success">SI</span>';
          if (value === 'NO') value = '<span class="badge badge-error">NO</span>';
        }

        html += '<div class="detail-row"><div class="detail-label">' + header + '</div><div class="detail-value">' + (value || '‚Äî') + '</div></div>';
      });

      document.getElementById('modalBody').innerHTML = html;
      document.getElementById('detailModal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('detailModal').classList.remove('show');
    }

    function toggleForm() {
      var form = document.getElementById('formSection');
      form.classList.toggle('collapsed');
    }

    function submitForm(e) {
      e.preventDefault();
      showMessage('‚è≥ Guardando auditor√≠a...', 'success');

      var formData = new FormData(e.target);
      var data = {};
      for (var pair of formData.entries()) {
        data[pair[0]] = pair[1];
      }

      fetch(GOOGLE_APPS_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
        mode: 'no-cors'
      })
      .then(function() {
        showMessage('‚úÖ Auditor√≠a guardada exitosamente', 'success');
        e.target.reset();
        setTimeout(function() {
          document.getElementById('formSection').classList.add('collapsed');
          setTimeout(function() {
            loadDataFromGoogleSheets();
          }, 1500);
        }, 500);
      })
      .catch(function(error) {
        showMessage('‚úÖ Auditor√≠a guardada', 'success');
        e.target.reset();
        setTimeout(function() {
          document.getElementById('formSection').classList.add('collapsed');
          setTimeout(function() {
            loadDataFromGoogleSheets();
          }, 1500);
        }, 500);
      });
    }

    function filterTable(query) {
      searchQuery = query.toLowerCase();
      applyFilters();
    }

    function exportToCSV() {
      if (filteredData.length === 0) {
        alert('No hay datos para exportar');
        return;
      }
      var headers = Object.keys(filteredData[0]);
      var csv = headers.join(',') + '\n' + filteredData.map(function(row) {
        return headers.map(function(h) { return '"' + (row[h] || '') + '"'; }).join(',');
      }).join('\n');
      var blob = new Blob([csv], { type: 'text/csv' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      var fileName = 'auditoria';
      if (currentCampana) fileName += '-' + currentCampana;
      if (currentEjecutivo) fileName += '-' + currentEjecutivo;
      fileName += '-' + new Date().toISOString().split('T')[0] + '.csv';
      a.download = fileName;
      a.click();
    }

    function showMessage(text, type) {
      var container = document.getElementById('messageContainer');
      container.innerHTML = '<div class="message message-' + type + '">' + text + '</div>';
      setTimeout(function() { container.innerHTML = ''; }, 4000);
    }

    window.onload = function() {
      loadDataFromGoogleSheets();
      startAutoRefresh();
    };


    
    
    // L√ìGICA DE FEEDBACK VISUAL CON M√öLTIPLES FILTROS
    function initFeedbackTab() {
        var select = document.getElementById('feedbackEjecutivoFilter');
        var currentVal = select.value;

        // Obtener lista √∫nica de ejecutivos
        var ejecutivos = [...new Set(allData.map(d => d['Ejecutivo']).filter(Boolean))].sort();

        select.innerHTML = '<option value="">Selecciona un ejecutivo...</option>';
        ejecutivos.forEach(ej => {
            var option = document.createElement('option');
            option.value = ej;
            option.textContent = ej;
            if(ej === currentVal) option.selected = true;
            select.appendChild(option);
        });
    }

    function renderFeedbackView() {
        var ejecutivo = document.getElementById('feedbackEjecutivoFilter').value;
        var campana = document.getElementById('feedbackCampanaFilter').value;
        var supervisor = document.getElementById('feedbackSupervisorFilter').value;

        var display = document.getElementById('feedbackDisplay');
        var empty = document.getElementById('feedbackEmptyState');
        var posContainer = modal ? modal.querySelector('#positiveContainer') : document.getElementById('positiveContainer');
        var impContainer = modal ? modal.querySelector('#improvementContainer') : document.getElementById('improvementContainer');

        if (!ejecutivo) {
            display.style.display = 'none';
            empty.style.display = 'block';
            empty.textContent = 'Selecciona un ejecutivo para ver sus observaciones.';
            return;
        }

        // Filtrar datos con todos los criterios
        var datosFiltrados = allData.filter(d => {
            return d['Ejecutivo'] === ejecutivo &&
                   (!campana || d['Campa√±a'] === campana) &&
                   (!supervisor || d['Supervisor'] === supervisor);
        });

        if (datosFiltrados.length === 0) {
            display.style.display = 'none';
            empty.style.display = 'block';
            empty.textContent = 'No hay registros que coincidan con los filtros seleccionados.';
            return;
        }

        display.style.display = 'block';
        empty.style.display = 'none';
        posContainer.innerHTML = '';
        impContainer.innerHTML = '';

        // Recorrer datos y generar items en recuadros ordenados
        datosFiltrados.forEach(d => {
            var fecha = d['Fecha de Evaluaci√≥n'] || 'Sin fecha';
            var campanaBadge = d['Campa√±a'] ? `<span class="badge" style="background:var(--color-surface);border:1px solid var(--color-border);margin-left:8px;font-size:10px;">${d['Campa√±a']}</span>` : '';

            // Observaciones Positivas
            if (d['Observaciones Positivas'] && d['Observaciones Positivas'].length > 2) {
                var item = document.createElement('div');
                item.className = 'feedback-item';
                item.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                        <span class="feedback-date">üìÖ ${fecha}</span>
                        ${campanaBadge}
                    </div>
                    <div style="color:var(--color-text);">${d['Observaciones Positivas']}</div>
                `;
                posContainer.appendChild(item);
            }

            // Observaciones Mejora
            if (d['Observaciones Mejora'] && d['Observaciones Mejora'].length > 2) {
                var item = document.createElement('div');
                item.className = 'feedback-item';
                item.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                        <span class="feedback-date">üìÖ ${fecha}</span>
                        ${campanaBadge}
                    </div>
                    <div style="color:var(--color-text);">${d['Observaciones Mejora']}</div>
                `;
                impContainer.appendChild(item);
            }
        });

        if (posContainer.children.length === 0) posContainer.innerHTML = '<div style="text-align:center;padding:20px;color:var(--color-text-secondary);font-style:italic;background:var(--color-surface);border-radius:8px;">Sin observaciones positivas registradas.</div>';
        if (impContainer.children.length === 0) impContainer.innerHTML = '<div style="text-align:center;padding:20px;color:var(--color-text-secondary);font-style:italic;background:var(--color-surface);border-radius:8px;">Sin oportunidades de mejora registradas.</div>';
    }

    var originalPopulate = populateEjecutivoFilter;
    populateEjecutivoFilter = function() {
        originalPopulate();
        initFeedbackTab();
    };

    // FUNCIONES PARA GESTIONAR PESTA√ëAS
    
function switchTab(tabName){
  // Tabs: activar contenido
  document.querySelectorAll('.tab-content').forEach(function(tab){
    tab.classList.remove('active');
  });
  var target = document.getElementById(tabName);
  if(target) target.classList.add('active');

  // Tabs-buttons (si existen)
  document.querySelectorAll('.tab-button').forEach(function(btn){
    btn.classList.remove('active');
  });

  // Sidebar: marcar activo por data-tab
  document.querySelectorAll('.sidebar-link').forEach(function(btn){
    btn.classList.toggle('active', btn.getAttribute('data-tab') === tabName);
  });
}

    // FUNCIONES PARA FEEDBACK
    var selectedFeedbackType = '';

    function selectFeedbackType(type) {
      var typeNames = {
        'positive': 'Comentario Positivo',
        'suggestion': 'Sugerencia',
        'issue': 'Reportar Problema'
      };

      selectedFeedbackType = type;
      document.getElementById('feedbackType').value = typeNames[type];

      // Actualizar estilos visuales
      var options = document.querySelectorAll('.feedback-option');
      options.forEach(function(opt) {
        opt.classList.remove('selected');
      });
      event.target.closest('.feedback-option').classList.add('selected');
    }

    function submitFeedback(e) {
      e.preventDefault();

      if (!selectedFeedbackType) {
        alert('Por favor selecciona un tipo de feedback');
        return;
      }

      var formData = new FormData(e.target);
      var data = {
        tipo: selectedFeedbackType,
        nombre: formData.get('nombre'),
        email: formData.get('email'),
        mensaje: formData.get('mensaje'),
        fecha: new Date().toLocaleString('es-PE')
      };

      console.log('üìß Feedback enviado:', data);
      showMessage('‚úÖ ¬°Gracias por tu feedback!', 'success');
      e.target.reset();
      document.getElementById('feedbackType').value = '';
      selectedFeedbackType = '';
      document.querySelectorAll('.feedback-option').forEach(function(opt) {
        opt.classList.remove('selected');
      });
    }

  

  function cargarObservaciones(){
      function _get(d, keys){ for (var i=0;i<keys.length;i++){ if(d[keys[i]]!==undefined) return d[keys[i]]; } return ''; }
var ejecutivo = document.getElementById('feedbackEjecutivoFilter').value;
    var campana = document.getElementById('feedbackCampanaFilter').value;
    var supervisor = document.getElementById('feedbackSupervisorFilter').value;
    var fecha = document.getElementById('feedbackFechaFilter').value;
    var telefono = document.getElementById('feedbackTelefonoFilter') ? document.getElementById('feedbackTelefonoFilter').value : '';

    var modal = document.getElementById('feedbackDetailModal');
    var posContainer = document.getElementById('positiveContainer');
    var impContainer = document.getElementById('improvementContainer');
    var titulo = document.getElementById('feedbackDetailTitle');

    if(!ejecutivo){
      alert('Selecciona un ejecutivo');
      return;
    }

    var baseData = (typeof currentFilteredData !== 'undefined' && Array.isArray(currentFilteredData) && currentFilteredData.length) ? currentFilteredData : allData;

    var filtrados = baseData.filter(function(d){
      var matchFecha = !fecha || _get(d,['Fecha de Evaluaci√≥n','Fecha de Evaluacion','Fecha de Evaluaci√≥n']) === fecha;
      var matchTelefono = !telefono || (d['Tel√©fono evaluado'] === telefono) || (d['Tel√©fono'] === telefono) || (d['Telefono'] === telefono) || (d['TEL√âFONO'] === telefono);
      return _get(d,['Ejecutivo']) === ejecutivo &&
             (!campana || _get(d,['Campa√±a','Campaa']) === campana) &&
             (!supervisor || _get(d,['Supervisor']) === supervisor) &&
             matchFecha &&
             matchTelefono;
    });

    posContainer.innerHTML = '';
    impContainer.innerHTML = '';
    titulo.textContent = ejecutivo + (fecha ? ' - ' + fecha : '');

    filtrados.forEach(function(d){
      var f = d['Fecha de Evaluaci√≥n'] || '';

      if(d['Observaciones Positivas']){
        var item = document.createElement('div');
        item.style.marginBottom = '12px';
        item.style.padding = '10px';
        item.style.background = 'rgba(16,185,129,0.05)';
        item.style.borderRadius = '6px';
        item.innerHTML = '<div style="font-size:12px;color:#666;margin-bottom:4px;">üìÖ ' + f + '</div><div>' + d['Observaciones Positivas'] + '</div>';
        posContainer.appendChild(item);
      }

      if(d['Observaciones Mejora']){
        var item = document.createElement('div');
        item.style.marginBottom = '12px';
        item.style.padding = '10px';
        item.style.background = 'rgba(239,68,68,0.05)';
        item.style.borderRadius = '6px';
        item.innerHTML = '<div style="font-size:12px;color:#666;margin-bottom:4px;">üìÖ ' + f + '</div><div>' + d['Observaciones Mejora'] + '</div>';
        impContainer.appendChild(item);
      }
    });

    if(posContainer.children.length === 0) {
      posContainer.innerHTML = '<div style="text-align:center;padding:20px;color:#9ca3af;">Sin observaciones positivas</div>';
    }
    if(impContainer.children.length === 0) {
      impContainer.innerHTML = '<div style="text-align:center;padding:20px;color:#9ca3af;">Sin oportunidades de mejora</div>';
    }

    modal.style.display = 'flex';
    populateFilters();
  }

  function cerrarFeedbackModal(){
    document.getElementById('feedbackDetailModal').style.display = 'none';
  }


  function populateFilters(){
    var ejecutivos = {};
    var campanas = {};
    var supervisores = {};

    allData.forEach(function(d){
      if(d['Ejecutivo']) ejecutivos[d['Ejecutivo']] = true;
      if(d['Campa√±a']) campanas[d['Campa√±a']] = true;
      if(d['Supervisor']) supervisores[d['Supervisor']] = true;
    });

    var ejecFeedback = document.getElementById('feedbackEjecutivoFilter');
    if(ejecFeedback) {
      ejecFeedback.innerHTML = '<option value="">Selecciona un ejecutivo...</option>';
      Object.keys(ejecutivos).sort().forEach(function(e){
        var opt = document.createElement('option');
        opt.value = e;
        opt.textContent = e;
        ejecFeedback.appendChild(opt);
      });
    }

    var campFeedback = document.getElementById('feedbackCampanaFilter');
    if(campFeedback) {
      campFeedback.innerHTML = '<option value="">Todas las campa√±as</option>';
      Object.keys(campanas).sort().forEach(function(c){
        var opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        campFeedback.appendChild(opt);
      });
    }

    var supFeedback = document.getElementById('feedbackSupervisorFilter');
    if(supFeedback) {
      supFeedback.innerHTML = '<option value="">Todos los supervisores</option>';
      Object.keys(supervisores).sort().forEach(function(s){
        var opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        supFeedback.appendChild(opt);
      });
    }
  }
  function renderFeedbackView(){
    var ejecutivo = document.getElementById('feedbackEjecutivoFilter').value;
    var campana = document.getElementById('feedbackCampanaFilter').value;
    var supervisor = document.getElementById('feedbackSupervisorFilter').value;
    var selectFecha = document.getElementById('feedbackFechaFilter');
    var display = document.getElementById('feedbackDisplay');
    var empty = document.getElementById('feedbackEmptyState');

    if(!ejecutivo){
      display.style.display = 'none';
      empty.style.display = 'block';
      selectFecha.innerHTML = '<option value="">Todas las fechas</option>';
      return;
    }

    var filtrados = allData.filter(function(d){
      return d['Ejecutivo'] === ejecutivo && 
             (!campana || d['Campa√±a'] === campana) &&
             (!supervisor || d['Supervisor'] === supervisor);
    });

    var fechasMap = {};
    filtrados.forEach(function(d){
      if(d['Fecha de Evaluaci√≥n'] && d['Fecha de Evaluaci√≥n'].trim()){
        fechasMap[d['Fecha de Evaluaci√≥n']] = true;
      }
    });

    var listaFechas = Object.keys(fechasMap).sort().reverse();

    selectFecha.innerHTML = '<option value="">Todas las fechas</option>';
    listaFechas.forEach(function(f){
      var opt = document.createElement('option');
      opt.value = f;
      opt.textContent = f;
      selectFecha.appendChild(opt);
    });

    display.style.display = 'block';
    empty.style.display = 'none';
  }

  // VARIABLE GLOBAL PARA ALMACENAR DATOS FILTRADOS
  var currentFilteredData = [];

  function updateFeedbackFilters(){
    var ejecutivo = document.getElementById('feedbackEjecutivoFilter').value;
    var selCamp = document.getElementById('feedbackCampanaFilter');
    var selSup = document.getElementById('feedbackSupervisorFilter');
    var selFecha = document.getElementById('feedbackFechaFilter');

    // Si no hay ejecutivo, reiniciar todo
    if(!ejecutivo){
        selCamp.innerHTML = '<option value="">Todas las campa√±as</option>';
        selSup.innerHTML = '<option value="">Todos los supervisores</option>';
        selFecha.innerHTML = '<option value="">Todas las fechas</option>';
        return;
    }

    // Filtrar datos base por ejecutivo
    var datosEjecutivo = [];
    if(typeof allData !== 'undefined'){
        datosEjecutivo = allData.filter(function(d){
            return d['Ejecutivo'] === ejecutivo;
        });
    }

    // Obtener Campa√±as, Supervisores y Fechas de este ejecutivo
    var campanas = {};
    var supervisores = {};
    var fechas = {};

    datosEjecutivo.forEach(function(d){
        if(d['Campa√±a']) campanas[d['Campa√±a']] = true;
        if(d['Supervisor']) supervisores[d['Supervisor']] = true;
        if(d['Fecha de Evaluaci√≥n']) fechas[d['Fecha de Evaluaci√≥n']] = true;
    });

    // Actualizar Select Campa√±a
    var campActual = selCamp.value;
    selCamp.innerHTML = '<option value="">Todas las campa√±as</option>';
    Object.keys(campanas).sort().forEach(function(c){
        var opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        selCamp.appendChild(opt);
    });
    // Intentar mantener selecci√≥n si existe en las nuevas opciones
    if(campanas[campActual]) selCamp.value = campActual;

    // Actualizar Select Supervisor
    var supActual = selSup.value;
    selSup.innerHTML = '<option value="">Todos los supervisores</option>';
    Object.keys(supervisores).sort().forEach(function(s){
        var opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        selSup.appendChild(opt);
    });
    if(supervisores[supActual]) selSup.value = supActual;

    // Actualizar Select Fecha
    var fechaActual = selFecha.value;
    selFecha.innerHTML = '<option value="">Todas las fechas</option>';
    Object.keys(fechas).sort().reverse().forEach(function(f){
        var opt = document.createElement('option');
        opt.value = f;
        opt.textContent = f;
        selFecha.appendChild(opt);
    });
    // Aqu√≠ es CLAVE: Si la fecha seleccionada antes sigue siendo v√°lida para este ejecutivo, mantenerla
    // Si no, resetear a "Todas las fechas"
    if(fechas[fechaActual]) selFecha.value = fechaActual;
  }

  // Modificar populateFeedbackFilters para asignar el evento correcto
  function populateFeedbackFilters(){
    var ejecutivos = {};

    if(typeof allData !== 'undefined'){
        allData.forEach(function(d){
            if(d['Ejecutivo']) ejecutivos[d['Ejecutivo']] = true;
        });
    }

    var selEjec = document.getElementById('feedbackEjecutivoFilter');
    if(selEjec){
        selEjec.innerHTML = '<option value="">Selecciona un ejecutivo...</option>';
        Object.keys(ejecutivos).sort().forEach(function(e){
            var opt = document.createElement('option');
            opt.value = e;
            opt.textContent = e;
            selEjec.appendChild(opt);
        });

        // ASIGNAR EL NUEVO LISTENER DE FILTRADO EN CADENA
        selEjec.removeEventListener('change', updateFechaFilter); // Remover viejo si existe
        selEjec.addEventListener('change', updateFeedbackFilters);
    }
  }

</script>
<script>
// ==========================================
// PARCHE DE CORRECCI√ìN DE FILTROS (vFinal)
// ==========================================

// Variable global para controlar estado
var _feedbackState = {
    ejecutivo: '',
    fecha: ''
};

// Sobrescribir renderFeedbackView para controlar la l√≥gica fina
// Esta funci√≥n ahora ser√° el orquestador principal
window.renderFeedbackView = function() {
    var ejecutivo = document.getElementById('feedbackEjecutivoFilter').value;
    var campana = document.getElementById('feedbackCampanaFilter').value;
    var supervisor = document.getElementById('feedbackSupervisorFilter').value;
    var fechaSelect = document.getElementById('feedbackFechaFilter');
    var fecha = fechaSelect.value;

    var display = document.getElementById('feedbackDisplay');
    var empty = document.getElementById('feedbackEmptyState');
    var posContainer = document.getElementById('positiveContainer');
    var impContainer = document.getElementById('improvementContainer');

    // DETECTAR CAMBIO DE EJECUTIVO
    if (ejecutivo !== _feedbackState.ejecutivo) {
        _feedbackState.ejecutivo = ejecutivo;
        // Si cambia ejecutivo, hay que repoblar dependientes
        if (ejecutivo) {
            actualizarFiltrosDependientes(ejecutivo);
        } else {
            // Limpiar todo
            limpiarSelect('feedbackCampanaFilter', 'Todas las campa√±as');
            limpiarSelect('feedbackSupervisorFilter', 'Todos los supervisores');
            limpiarSelect('feedbackFechaFilter', 'Todas las fechas');
        }
        // Resetear fecha interna porque cambi√≥ el ejecutivo
        _feedbackState.fecha = ''; 
    }

    // SI NO HAY EJECUTIVO SELECCIONADO
    if (!ejecutivo) {
        if(display) display.style.display = 'none';
        if(empty) {
            empty.style.display = 'block';
            empty.textContent = 'Selecciona un ejecutivo para ver sus observaciones.';
        }
        return;
    }

    // APLICAR FILTROS
    // Importante: No repoblar fecha aqu√≠ para no perder la selecci√≥n

    var datosFiltrados = [];
    if (typeof allData !== 'undefined') {
        datosFiltrados = allData.filter(function(d) {
            return d['Ejecutivo'] === ejecutivo &&
                   (!campana || d['Campa√±a'] === campana) &&
                   (!supervisor || d['Supervisor'] === supervisor) &&
                   (!fecha || d['Fecha de Evaluaci√≥n'] === fecha);
        });
    }

    // RENDERIZAR RESULTADOS
    if (datosFiltrados.length === 0) {
        if(display) display.style.display = 'none';
        if(empty) {
            empty.style.display = 'block';
            empty.textContent = 'No hay registros con esos filtros.';
        }
    } else {
        if(display) display.style.display = 'block';
        if(empty) empty.style.display = 'none';

        if(posContainer) posContainer.innerHTML = '';
        if(impContainer) impContainer.innerHTML = '';

        datosFiltrados.forEach(function(d) {
            var f = d['Fecha de Evaluaci√≥n'] || 'Sin fecha';
            var badge = d['Campa√±a'] ? '<span class="badge" style="background:#f3f4f6;border:1px solid #e5e7eb;margin-left:8px;font-size:10px;padding:2px 6px;border-radius:4px;">' + d['Campa√±a'] + '</span>' : '';

            // Positivas
            if (d['Observaciones Positivas'] && d['Observaciones Positivas'].length > 2 && posContainer) {
                var div = document.createElement('div');
                div.className = 'feedback-item';
                div.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">' +
                                '<span class="feedback-date">üìÖ ' + f + '</span>' + badge + '</div>' +
                                '<div style="color:#374151;">' + d['Observaciones Positivas'] + '</div>';
                posContainer.appendChild(div);
            }

            // Mejora
            if (d['Observaciones Mejora'] && d['Observaciones Mejora'].length > 2 && impContainer) {
                var div = document.createElement('div');
                div.className = 'feedback-item';
                div.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">' +
                                '<span class="feedback-date">üìÖ ' + f + '</span>' + badge + '</div>' +
                                '<div style="color:#374151;">' + d['Observaciones Mejora'] + '</div>';
                impContainer.appendChild(div);
            }
        });

        if (posContainer && posContainer.children.length === 0) posContainer.innerHTML = '<div style="text-align:center;padding:20px;color:#9ca3af;font-style:italic;background:#f9fafb;border-radius:8px;">Sin observaciones positivas.</div>';
        if (impContainer && impContainer.children.length === 0) impContainer.innerHTML = '<div style="text-align:center;padding:20px;color:#9ca3af;font-style:italic;background:#f9fafb;border-radius:8px;">Sin oportunidades de mejora.</div>';
    }
};

// Funci√≥n auxiliar para actualizar filtros dependientes
function actualizarFiltrosDependientes(ejecutivo) {
    if (typeof allData === 'undefined') return;

    var datos = allData.filter(function(d){ return d['Ejecutivo'] === ejecutivo; });
    var campanas = {};
    var supervisores = {};
    var fechas = {};

    datos.forEach(function(d){
        if(d['Campa√±a']) campanas[d['Campa√±a']] = true;
        if(d['Supervisor']) supervisores[d['Supervisor']] = true;
        if(d['Fecha de Evaluaci√≥n']) fechas[d['Fecha de Evaluaci√≥n']] = true;
    });

    llenarSelect('feedbackCampanaFilter', campanas, 'Todas las campa√±as');
    llenarSelect('feedbackSupervisorFilter', supervisores, 'Todos los supervisores');
    llenarSelect('feedbackFechaFilter', fechas, 'Todas las fechas', true); // true = ordenar fechas
}

function llenarSelect(id, mapDatos, defaultText, esFecha) {
    var sel = document.getElementById(id);
    if (!sel) return;

    sel.innerHTML = '<option value="">' + defaultText + '</option>';
    var keys = Object.keys(mapDatos);

    if (esFecha) keys.sort().reverse();
    else keys.sort();

    keys.forEach(function(k){
        var opt = document.createElement('option');
        opt.value = k;
        opt.textContent = k;
        sel.appendChild(opt);
    });
}

function limpiarSelect(id, defaultText) {
    var sel = document.getElementById(id);
    if(sel) sel.innerHTML = '<option value="">' + defaultText + '</option>';
}

// Sobrescribir cargarObservaciones para usar la l√≥gica centralizada si es necesario
// En este caso, el bot√≥n VER llama a cargarObservaciones(), pero en tu dise√±o actual parece que el renderizado es autom√°tico al cambiar filtros.
// Si el bot√≥n VER existe, haremos que simplemente llame a renderFeedbackView para asegurar consistencia


// Asegurar que populateFilters inicializa bien
var oldPopulate = window.populateFilters;
window.populateFilters = function() {
    if(oldPopulate) oldPopulate();

    // Forzar limpieza inicial de dependientes
    limpiarSelect('feedbackCampanaFilter', 'Todas las campa√±as');
    limpiarSelect('feedbackSupervisorFilter', 'Todos los supervisores');
    limpiarSelect('feedbackFechaFilter', 'Todas las fechas');
};



// ==========================================
// SOLUCI√ìN DE TEL√âFONOS - FINAL
// ==========================================
window.actualizarTelefonos = function() {
    var ejecutivo = document.getElementById('feedbackEjecutivoFilter').value;
    var campana = document.getElementById('feedbackCampanaFilter').value;
    var supervisor = document.getElementById('feedbackSupervisorFilter').value;
    var fecha = document.getElementById('feedbackFechaFilter').value;
    var selTel = document.getElementById('feedbackTelefonoFilter');

    if (!selTel) return;

    // Si no hay datos cargados a√∫n, salir
    if (typeof allData === 'undefined' || allData.length === 0) {
        selTel.innerHTML = '<option value="">Cargando...</option>';
        return;
    }

    // Si no hay ejecutivo, mostrar todos
    if (!ejecutivo) {
        selTel.innerHTML = '<option value="">Todos los tel√©fonos</option>';
        return;
    }

    // Filtrar datos seg√∫n los filtros actuales
    var filtrados = allData.filter(function(d) {
        return d['Ejecutivo'] === ejecutivo &&
               (!campana || d['Campa√±a'] === campana) &&
               (!supervisor || d['Supervisor'] === supervisor) &&
               (!fecha || d['Fecha de Evaluaci√≥n'] === fecha);
    });

    // Extraer tel√©fonos √∫nicos
    var telefonos = {};
    filtrados.forEach(function(d) {
        if (d['Tel√©fono evaluado']) {
            telefonos[d['Tel√©fono evaluado']] = true;
        }
    });

    // Llenar select
    selTel.innerHTML = '<option value="">Todos los tel√©fonos</option>';
    Object.keys(telefonos).sort().forEach(function(tel) {
        var opt = document.createElement('option');
        opt.value = tel;
        opt.textContent = tel;
        selTel.appendChild(opt);
    });
};

// Llamar cuando cambia ejecutivo (la cascada principal)
document.getElementById('feedbackEjecutivoFilter').addEventListener('change', function() {
    window.actualizarTelefonos();
});

// Llamar tambi√©n cuando cambia fecha/campa√±a/supervisor
document.getElementById('feedbackFechaFilter').addEventListener('change', function() {
    window.actualizarTelefonos();
});
document.getElementById('feedbackCampanaFilter').addEventListener('change', function() {
    window.actualizarTelefonos();
});
document.getElementById('feedbackSupervisorFilter').addEventListener('change', function() {
    window.actualizarTelefonos();
});

// Llamar cuando se cargan los datos inicialmente
var loadDataFromGoogleSheets_original = window.loadDataFromGoogleSheets;
window.loadDataFromGoogleSheets = function() {
    loadDataFromGoogleSheets_original();
    setTimeout(function() {
        window.actualizarTelefonos();
    }, 500);
};



    // === PARCHE ROBUSTO TEL√âFONO + AUTO-DETALLE (NUEVO) ===
    (function () {
      function detectPhoneKey(row) {
        if (!row) return null;
        const candidates = ['Tel√©fono evaluado','Tel√©fono','Telefono','TEL√âFONO','TELEFONO'];
        for (const k of candidates) {
          if (Object.prototype.hasOwnProperty.call(row, k)) return k;
        }
        const keys = Object.keys(row);
        return keys.find(k => String(k).toLowerCase().includes('tel')) || null;
      }

      window.actualizarTelefonos = function () {
        const ejecutivo = document.getElementById('feedbackEjecutivoFilter')?.value || '';
        const campana = document.getElementById('feedbackCampanaFilter')?.value || '';
        const supervisor = document.getElementById('feedbackSupervisorFilter')?.value || '';
        const fecha = document.getElementById('feedbackFechaFilter')?.value || '';
        const selTel = document.getElementById('feedbackTelefonoFilter');
        if (!selTel) return;

        if (typeof window.allData === 'undefined' || !Array.isArray(window.allData) || window.allData.length === 0) {
          selTel.innerHTML = '<option value="">Cargando...</option>';
          return;
        }

        if (!ejecutivo) {
          selTel.innerHTML = '<option value="">Todos los tel√©fonos</option>';
          return;
        }

        const telActual = selTel.value;

        const filtrados = window.allData.filter(function (d) {
          return d['Ejecutivo'] === ejecutivo &&
            (!campana || d['Campa√±a'] === campana) &&
            (!supervisor || d['Supervisor'] === supervisor) &&
            (!fecha || d['Fecha de Evaluaci√≥n'] === fecha);
        });

        const phoneKey = detectPhoneKey(filtrados[0] || window.allData[0]);
        const telefonos = {};
        filtrados.forEach(function (d) {
          const tel = phoneKey ? (d[phoneKey] || '') : '';
          const clean = String(tel).trim();
          if (clean) telefonos[clean] = true;
        });

        selTel.innerHTML = '<option value="">Todos los tel√©fonos</option>';
        Object.keys(telefonos).sort().forEach(function (tel) {
          const opt = document.createElement('option');
          opt.value = tel;
          opt.textContent = tel;
          selTel.appendChild(opt);
        });

        if (telActual && telefonos[telActual]) selTel.value = telActual;
      };

      // Cascada: al cambiar cualquier filtro superior, actualizar tel√©fonos
      ['feedbackEjecutivoFilter','feedbackCampanaFilter','feedbackSupervisorFilter','feedbackFechaFilter'].forEach(function(id){
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('change', function(){
          window.actualizarTelefonos();
        });
      });

      // Al seleccionar un tel√©fono: abrir modal y cargar las observaciones de ese n√∫mero
      document.addEventListener('change', function(e){
        if (e.target && e.target.id === 'feedbackTelefonoFilter') {
          if (typeof window.cargarObservaciones === 'function') window.cargarObservaciones();
        }
      });

      // Inicial
      window.addEventListener('load', function(){
        setTimeout(function(){
          if (typeof window.actualizarTelefonos === 'function') window.actualizarTelefonos();
        }, 900);
      });
    })();


// === OVERRIDE FINAL: VER (Feedback) -> muestra observaciones del Dashboard filtradas por TEL√âFONO ===
function cargarObservaciones(){
  var telefono = (document.getElementById('feedbackTelefonoFilter') && document.getElementById('feedbackTelefonoFilter').value) ? String(document.getElementById('feedbackTelefonoFilter').value).trim() : '';
  if(!telefono){
    alert('Selecciona un tel√©fono');
    return;
  }

  // Base: lo que est√° en pantalla en Dashboard (filteredData). Fallback: allData.
  var baseData = (typeof filteredData !== 'undefined' && Array.isArray(filteredData) && filteredData.length) ? filteredData :
                 ((typeof currentFilteredData !== 'undefined' && Array.isArray(currentFilteredData) && currentFilteredData.length) ? currentFilteredData : allData);

  function getVal(d, keys){
    for (var i=0; i<keys.length; i++){
      var k = keys[i];
      if (d && Object.prototype.hasOwnProperty.call(d, k) && d[k] !== undefined && d[k] !== null) return String(d[k]);
    }
    // fallback por nombre aproximado
    if (d){
      var ks = Object.keys(d);
      for (var j=0; j<ks.length; j++){
        var low = ks[j].toLowerCase();
        for (var i2=0;i2<keys.length;i2++){
          if (low === String(keys[i2]).toLowerCase()) return String(d[ks[j]]);
        }
      }
    }
    return '';
  }

  // Filtrar SOLO por tel√©fono
  var filtrados = baseData.filter(function(d){
    var tel = getVal(d, ['Tel√©fono evaluado','Telefono evaluado','Tel√©fono','Telefono','TEL√âFONO','TELEFONO']).trim();
    return tel === telefono;
  });

  var modal = document.getElementById('feedbackDetailModal');
  if(!modal){
    alert('No se encontr√≥ el modal de feedback (feedbackDetailModal).');
    return;
  }

  // Contenedores dentro del modal (evita IDs duplicados)
  var posContainer = modal.querySelector('#positiveContainer') || modal.querySelector('#positiveContainerModal');
  var impContainer = modal.querySelector('#improvementContainer') || modal.querySelector('#improvementContainerModal');
  var titulo = document.getElementById('feedbackDetailTitle');

  if(posContainer) posContainer.innerHTML = '';
  if(impContainer) impContainer.innerHTML = '';

  // T√≠tulo: Ejecutivo (si existe) + Tel√©fono
  var ejecutivoTitulo = filtrados.length ? getVal(filtrados[0], ['Ejecutivo']).trim() : '';
  if(titulo) titulo.textContent = (ejecutivoTitulo ? (ejecutivoTitulo + ' - ') : '') + telefono;

  // Pintar resultados
  filtrados.forEach(function(d){
    var f = getVal(d, ['Fecha de Evaluaci√≥n','Fecha de Evaluacion','Fecha de Evaluaci√≥n']).trim();
    var pos = getVal(d, ['Observaciones Positivas']).trim();
    var imp = getVal(d, ['Observaciones Mejora','Observaciones de Mejora','Oportunidades de Mejora','Puntos de Mejora']).trim();

    if(pos && posContainer){
      var item = document.createElement('div');
      item.style.marginBottom = '12px';
      item.style.padding = '10px';
      item.style.background = 'rgba(16,185,129,0.05)';
      item.style.borderRadius = '6px';
      item.innerHTML = (f ? ('<div style="font-size:12px;color:#666;margin-bottom:4px;">üìÖ ' + f + '</div>') : '') + '<div>' + pos + '</div>';
      posContainer.appendChild(item);
    }

    if(imp && impContainer){
      var item2 = document.createElement('div');
      item2.style.marginBottom = '12px';
      item2.style.padding = '10px';
      item2.style.background = 'rgba(239,68,68,0.05)';
      item2.style.borderRadius = '6px';
      item2.innerHTML = (f ? ('<div style="font-size:12px;color:#666;margin-bottom:4px;">üìÖ ' + f + '</div>') : '') + '<div>' + imp + '</div>';
      impContainer.appendChild(item2);
    }
  });

  if(posContainer && posContainer.children.length === 0){
    posContainer.innerHTML = '<div style="text-align:center;padding:20px;color:#666;font-style:italic;">Sin observaciones positivas registradas para este tel√©fono.</div>';
  }
  if(impContainer && impContainer.children.length === 0){
    impContainer.innerHTML = '<div style="text-align:center;padding:20px;color:#666;font-style:italic;">Sin oportunidades de mejora registradas para este tel√©fono.</div>';
  }

  // Abrir modal
  modal.style.display = 'flex';
}


// === PAGINACI√ìN TABLA DASHBOARD (OVERRIDE NO-INVASIVO) ===
(function(){
  var PAGE_SIZE = 5;
  var _dashPage = 1;

  function ensurePagerUI(){
    var body = document.getElementById('tableBody');
    if(!body) return;
    var table = body.closest('table');
    if(!table) return;
    var container = table.parentElement; // .table-container
    if(!container) return;

    if(document.getElementById('paginationControls')) return;

    var pager = document.createElement('div');
    pager.id = 'paginationControls';
    pager.style.cssText = 'display:flex;justify-content:flex-end;align-items:center;gap:10px;margin-top:12px;flex-wrap:wrap;';

    pager.innerHTML = '<button class="btn btn-secondary btn-sm" id="prevPageBtn" type="button">Anterior</button>'+
      '<span id="pageInfo" style="font-size:12px;color:var(--color-text-secondary);"></span>'+
      '<button class="btn btn-secondary btn-sm" id="nextPageBtn" type="button">Siguiente</button>';

    container.appendChild(pager);

    document.getElementById('prevPageBtn').addEventListener('click', function(){
      if(_dashPage > 1){
        _dashPage--;
        window.renderTable();
      }
    });

    document.getElementById('nextPageBtn').addEventListener('click', function(){
      var total = (Array.isArray(window.filteredData) ? window.filteredData.length : 0);
      var totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      if(_dashPage < totalPages){
        _dashPage++;
        window.renderTable();
      }
    });
  }

  function updatePagerUI(){
    ensurePagerUI();
    var total = (Array.isArray(window.filteredData) ? window.filteredData.length : 0);
    var totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
    if(_dashPage > totalPages) _dashPage = totalPages;
    if(_dashPage < 1) _dashPage = 1;

    var info = document.getElementById('pageInfo');
    var prev = document.getElementById('prevPageBtn');
    var next = document.getElementById('nextPageBtn');
    var pag = document.getElementById('paginationControls');

    if(pag) pag.style.display = total > 0 ? 'flex' : 'none';
    if(info) info.textContent = 'P√°gina ' + _dashPage + ' de ' + totalPages + ' (Total: ' + total + ')';
    if(prev) prev.disabled = (_dashPage <= 1);
    if(next) next.disabled = (_dashPage >= totalPages);
  }

  // Hook: reset de p√°gina cuando cambia b√∫squeda/filtros (applyFilters y clearFilters)
  if(typeof window.applyFilters === 'function'){
    var _applyFilters = window.applyFilters;
    window.applyFilters = function(){
      _dashPage = 1;
      return _applyFilters.apply(this, arguments);
    };
  }

  if(typeof window.clearFilters === 'function'){
    var _clearFilters = window.clearFilters;
    window.clearFilters = function(){
      _dashPage = 1;
      return _clearFilters.apply(this, arguments);
    };
  }

  // Hook: paginar solo la tabla sin tocar KPIs/charts.
  if(typeof window.renderTable === 'function'){
    var _renderTable = window.renderTable;
    window.renderTable = function(){
      // backup
      var original = window.filteredData;
      try{
        if(Array.isArray(original)){
          var start = (_dashPage - 1) * PAGE_SIZE;
          var end = start + PAGE_SIZE;
          window.filteredData = original.slice(start, end);
        }
        // render con tu funci√≥n base
        var res = _renderTable.apply(this, arguments);
        return res;
      } finally {
        // restaurar data completa
        window.filteredData = original;
        updatePagerUI();

        // Ajustar los botones VER para que apunten al √≠ndice real (porque tu renderTable usa idx local)
        // Se hace despu√©s de que la tabla fue pintada.
        try{
          var body = document.getElementById('tableBody');
          if(body && Array.isArray(original)){
            var start = (_dashPage - 1) * PAGE_SIZE;
            var btns = body.querySelectorAll('button[onclick^="showDetail("]');
            btns.forEach(function(btn, i){
              btn.setAttribute('onclick', 'showDetail(' + (start + i) + ')');
            });
          }
        } catch(e) {}
      }
    };
  }

  // Crear UI cuando el dashboard se renderiza por primera vez
  document.addEventListener('DOMContentLoaded', function(){
    setTimeout(function(){
      updatePagerUI();
    }, 500);
  });
})();


// === Sync estado activo del men√∫ lateral ===
(function(){
  function setActive(tab){
    document.querySelectorAll('.sidebar-link').forEach(function(b){
      b.classList.toggle('active', b.getAttribute('data-tab') === tab);
    });
  }
  document.addEventListener('DOMContentLoaded', function(){
    var activeTab = document.querySelector('.tab-content.active');
    if(activeTab) setActive(activeTab.id);
  });
  if(typeof window.switchTab === 'function'){
    var _switchTab = window.switchTab;
    window.switchTab = function(tabName){
      var res = _switchTab.apply(this, arguments);
      setActive(tabName);
      if(tabName==='gestion') {
        var form=document.getElementById('formSection');
        if(form) form.classList.remove('collapsed');
      }

      return res;
    };
  }
})();


// =====================
// APARTADO: AN√ÅLISIS
// =====================
var analysisChartInstances = [];

function safeVal(d, keys, fallback) {
  fallback = (fallback === undefined) ? '' : fallback;
  if (!d) return fallback;
  // match exact keys
  for (var i = 0; i < keys.length; i++) {
    var k = keys[i];
    if (Object.prototype.hasOwnProperty.call(d, k)) {
      var vv = d[k];
      if (vv !== undefined && vv !== null && String(vv).trim() !== '') return String(vv).trim();
    }
  }
  // match by contains (robusto a cambios menores en headers)
  var dk = Object.keys(d);
  for (var j = 0; j < dk.length; j++) {
    var low = String(dk[j]).toLowerCase();
    for (var i2 = 0; i2 < keys.length; i2++) {
      var target = String(keys[i2]).toLowerCase();
      if (low === target || low.includes(target)) {
        var v = d[dk[j]];
        if (v !== undefined && v !== null && String(v).trim() !== '') return String(v).trim();
      }
    }
  }
  return fallback;
}

function pct(part, total) {
  if (!total || total <= 0) return 0;
  return Math.round((part / total) * 100);
}

function topNFromCounts(counts, n) {
  var arr = Object.keys(counts).map(function(k){ return {k:k, v:counts[k]}; });
  arr.sort(function(a,b){ return b.v - a.v; });
  return arr.slice(0, n || 5);
}

function destroyAnalysisCharts(){
  try {
    analysisChartInstances.forEach(function(c){ try{ c.destroy(); } catch(e){} });
  } catch(e) {}
  analysisChartInstances = [];
}

function renderAnalysis(){
  var base = (typeof filteredData !== 'undefined' && Array.isArray(filteredData) && filteredData.length)
    ? filteredData
    : (Array.isArray(allData) ? allData : []);

  var total = base.length;
  var kpiBox = document.getElementById('analysisKpis');
  var narrative = document.getElementById('analysisNarrative');

  if(!kpiBox || !narrative) return;

  if(total === 0){
    kpiBox.innerHTML = '<div class="kpis-section"><div class="kpis-section-title">Sin datos</div><div style="color:var(--color-text-secondary); font-size:13px;">No hay auditor√≠as para analizar con los filtros actuales.</div></div>';
    narrative.innerHTML = '<div style="padding:12px; background: var(--color-surface); border:1px solid var(--color-border); border-radius:10px;">Ajusta filtros o carga datos para generar hallazgos.</div>';
    destroyAnalysisCharts();
    return;
  }

  // === Keys (robustos a cambios de header) ===
  var keyTipo = ['Tipo de Llamada','Tipo de llamada','Tipo'];
  var keyCamp = ['Campa√±a','Campana','Campaa'];
  var keyMotivo = ['Motivo No Venta','Motivo de No Venta'];
  var keyResp = ['Responsabilidad'];

  var keyHab = ['Habilidad comercial','Habilidad Comercial'];
  var keySondeo = ['Sondeo'];
  var keyRebate = ['Rebate'];
  var keyNeces = ['Genera Necesidad','Genera necesidad'];
  var keyCierre = ['Cierre de Venta','Cierre de venta'];
  var keyBaja = ['Usa Baja','Usa baja'];

  // Campa√±as esperadas
  var CAMP_ORDER = ['Deepening','Pr√©stamos','Prestamos','Tarjetas','Tarjeta'];

  function normCamp(x){
    x = (x||'').toString().trim();
    var l = x.toLowerCase();
    if(l.includes('deep')) return 'Deepening';
    if(l.includes('pr√©st') || l.includes('prest') || l.includes('prst')) return 'Pr√©stamos';
    if(l.includes('tarj')) return 'Tarjetas';
    return x || 'Sin campa√±a';
  }

  function isVenta(t){
    t = (t||'').toString().trim().toLowerCase();
    return t === 'venta';
  }
  function isNoVenta(t){
    t = (t||'').toString().trim().toLowerCase();
    return (t === 'no venta' || t === 'noventa' || t.includes('no'));
  }

  // === Helpers espec√≠ficos de gesti√≥n ===
  function skillYesNo(v){
    v = (v||'').toString().trim().toUpperCase();
    if(v === 'SI' || v === 'S√ç') return 'SI';
    if(v === 'NO') return 'NO';
    return 'NA';
  }

  function execIndexRow(d){
    var keys = [keySondeo, keyNeces, keyRebate, keyCierre, keyBaja, keyHab];
    var yes = 0, valid = 0;
    keys.forEach(function(ka){
      var v = skillYesNo(safeVal(d, ka, 'NA'));
      if(v !== 'NA'){
        valid++;
        if(v === 'SI') yes++;
      }
    });
    if(valid === 0) return null;
    return { yes: yes, valid: valid, pct: (yes/valid) };
  }

  function pct0to100(x){ return Math.round((x||0) * 100); }

  // === 1) Totales y conversi√≥n ===
  var ventas = 0, noVentas = 0;
  base.forEach(function(d){
    var t = safeVal(d, keyTipo, 'NA');
    if(isVenta(t)) ventas++;
    else if(isNoVenta(t)) noVentas++;
  });

  // === 2) Stats por campa√±a ===
  var campStats = {}; // camp -> {total, venta, noVenta, execYes, execValid, respAgenteNoVenta, respTotalNoVenta, motivoTotalNoVenta, topMotivoCount}
  function ensureCamp(c){
    if(!campStats[c]) campStats[c] = { total:0, venta:0, noVenta:0, execYes:0, execValid:0, respAgenteNoVenta:0, respTotalNoVenta:0, motivoTotalNoVenta:0, topMotivoCount:0 };
    return campStats[c];
  }

  base.forEach(function(d){
    var camp = normCamp(safeVal(d, keyCamp, 'Sin campa√±a'));
    var st = ensureCamp(camp);

    var t = safeVal(d, keyTipo, 'NA');
    st.total++;
    if(isVenta(t)) st.venta++;
    if(isNoVenta(t)) st.noVenta++;

    var ex = execIndexRow(d);
    if(ex){ st.execYes += ex.yes; st.execValid += ex.valid; }

    if(isNoVenta(t)){
      // Responsabilidad
      var r = safeVal(d, keyResp, 'NA').toString().trim().toLowerCase();
      if(r && r !== 'na'){
        st.respTotalNoVenta++;
        if(r.includes('agente')) st.respAgenteNoVenta++;
      }
      // Motivo
      var m = safeVal(d, keyMotivo, 'NA').toString().trim();
      if(m && m !== 'NA') st.motivoTotalNoVenta++;
    }
  });

  // === 3) Motivos globales y por campa√±a ===
  var motivos = {};
  var motivosByCamp = {}; // camp -> counts
  base.forEach(function(d){
    var t = safeVal(d, keyTipo, '');
    if(isNoVenta(t)){
      var m = safeVal(d, keyMotivo, 'NA');
      motivos[m] = (motivos[m]||0)+1;
      var camp = normCamp(safeVal(d, keyCamp, 'Sin campa√±a'));
      if(!motivosByCamp[camp]) motivosByCamp[camp] = {};
      motivosByCamp[camp][m] = (motivosByCamp[camp][m]||0)+1;
    }
  });
  var topMotivos = topNFromCounts(motivos, 5);
  var topMotivo = topMotivos.length ? topMotivos[0] : null;

  // top1 share per campa√±a
  var campTopMotivoShare = {}; // camp -> share top1 of noVenta
  Object.keys(motivosByCamp).forEach(function(c){
    var mcounts = motivosByCamp[c];
    var tlist = topNFromCounts(mcounts, 1);
    var top1 = tlist.length ? tlist[0].v : 0;
    var totalNV = Object.values(mcounts).reduce(function(a,b){return a+b;},0);
    campTopMotivoShare[c] = { top1: top1, total: totalNV, pct: totalNV ? (top1/totalNV) : 0, label: tlist.length ? tlist[0].k : 'NA' };
  });

  // === 4) Quiebres skills global ===
  function countNo(keyArr){
    var c = 0;
    base.forEach(function(d){
      var v = skillYesNo(safeVal(d, keyArr, 'NA'));
      if(v === 'NO') c++;
    });
    return c;
  }
  var noHab = countNo(keyHab);
  var noSondeo = countNo(keySondeo);
  var noRebate = countNo(keyRebate);
  var noNeces = countNo(keyNeces);
  var noCierre = countNo(keyCierre);
  var noBaja = countNo(keyBaja);

  var skillCounts = {
    'Habilidad comercial': noHab,
    'Sondeo': noSondeo,
    'Rebate': noRebate,
    'Genera necesidad': noNeces,
    'Cierre de venta': noCierre,
    'Uso de baja': noBaja
  };
  var topSkills = topNFromCounts(skillCounts, 6);
  var topSkill = topSkills.length ? topSkills[0] : null;

  // === 5) Calidad de data (cobertura) ===
  var skillNA = 0, skillTotalChecks = 0;
  base.forEach(function(d){
    [keySondeo,keyNeces,keyRebate,keyCierre,keyBaja,keyHab].forEach(function(ka){
      skillTotalChecks++;
      if(skillYesNo(safeVal(d, ka, 'NA')) === 'NA') skillNA++;
    });
  });
  var skillNApct = skillTotalChecks ? (skillNA/skillTotalChecks) : 0;

  var motivoFilled = 0;
  base.forEach(function(d){
    if(isNoVenta(safeVal(d,keyTipo,''))){
      var m = safeVal(d, keyMotivo, 'NA');
      if(m && m !== 'NA') motivoFilled++;
    }
  });
  var motivoFillPct = noVentas ? (motivoFilled/noVentas) : 0;

  // Responsabilidad coverage (No venta)
  var respFilled = 0;
  base.forEach(function(d){
    if(isNoVenta(safeVal(d,keyTipo,''))){
      var r = safeVal(d, keyResp, 'NA');
      if(r && r !== 'NA') respFilled++;
    }
  });
  var respFillPct = noVentas ? (respFilled/noVentas) : 0;

  // === KPI HTML (10 KPIs) ===
  // Grupo 1: Resultado
  // Grupo 2: Coaching (ejecuci√≥n y quiebre)
  // Grupo 3: Oferta/Objeciones (motivos)
  // Grupo 4: Control (responsabilidad + calidad de data)

  var html = '';

  // RESULTADO
  html += '<div class="kpis-section"><div class="kpis-section-title">Resultado (qu√© tan bien est√° vendiendo)</div><div class="kpis-grid">';
  html += '<div class="kpi-card"><div class="kpi-label">Auditor√≠as analizadas</div><div class="kpi-value">'+total+'</div><div class="kpi-subtitle">Seg√∫n filtros del Dashboard</div></div>';
  html += '<div class="kpi-card"><div class="kpi-label">Conversi√≥n total</div><div class="kpi-value">'+pct(ventas,total)+'%</div><div class="kpi-subtitle">'+ventas+' ventas / '+total+'</div></div>';
  html += '<div class="kpi-card"><div class="kpi-label">Conversi√≥n (Top campa√±a)</div><div class="kpi-value">'+(function(){
      var best = {c:'NA', v:-1, t:0};
      Object.keys(campStats).forEach(function(c){
        var st = campStats[c];
        if(st.total >= 5){
          var cv = st.total ? (st.venta/st.total) : 0;
          if(cv > best.v){ best = {c:c, v:cv, t:st.total}; }
        }
      });
      return best.v < 0 ? '‚Äî' : (pct0to100(best.v)+'%');
    })()+'</div><div class="kpi-subtitle">Mejor campa√±a (muestra ‚â• 5)</div></div>';
  html += '</div></div>';

  // COACHING
  html += '<div class="kpis-section"><div class="kpis-section-title">Coaching (qu√© se ejecuta y d√≥nde se rompe)</div><div class="kpis-grid">';

  // Speech Execution Index global
  var execYes = 0, execValid = 0;
  Object.keys(campStats).forEach(function(c){ execYes += campStats[c].execYes; execValid += campStats[c].execValid; });
  var execIdx = execValid ? (execYes/execValid) : 0;
  html += '<div class="kpi-card"><div class="kpi-label">√çndice de ejecuci√≥n del speech</div><div class="kpi-value">'+pct0to100(execIdx)+'%</div><div class="kpi-subtitle">Promedio de ‚ÄúSI‚Äù en habilidades (sin NA)</div></div>';

  // Quiebre cr√≠tico
  html += '<div class="kpi-card"><div class="kpi-label">Quiebre cr√≠tico (Cierre)</div><div class="kpi-value">'+pct(noCierre,total)+'%</div><div class="kpi-subtitle">'+noCierre+' auditor√≠as con NO en cierre</div></div>';

  // Top quiebre
  if(topSkill){
    html += '<div class="kpi-card"><div class="kpi-label">Brecha #1</div><div class="kpi-value">'+pct(topSkill.v,total)+'%</div><div class="kpi-subtitle">'+topSkill.v+' quiebres en '+topSkill.k+'</div></div>';
  } else {
    html += '<div class="kpi-card"><div class="kpi-label">Brecha #1</div><div class="kpi-value">‚Äî</div><div class="kpi-subtitle">Sin datos</div></div>';
  }

  html += '</div></div>';

  // OBJECIONES / OFERTA
  html += '<div class="kpis-section"><div class="kpis-section-title">Objeciones (qu√© est√° frenando la venta)</div><div class="kpis-grid">';

  if(topMotivo){
    html += '<div class="kpi-card"><div class="kpi-label">Motivo #1 (No venta)</div><div class="kpi-value">'+pct(topMotivo.v, Math.max(1,noVentas))+'%</div><div class="kpi-subtitle">'+topMotivo.v+' casos</div><div class="kpi-motivo">'+topMotivo.k+'</div></div>';
  } else {
    html += '<div class="kpi-card"><div class="kpi-label">Motivo #1 (No venta)</div><div class="kpi-value">‚Äî</div><div class="kpi-subtitle">Sin registros</div></div>';
  }

  var top3sum = topMotivos.slice(0,3).reduce(function(a,x){ return a+x.v; }, 0);
  html += '<div class="kpi-card"><div class="kpi-label">Concentraci√≥n Top 3</div><div class="kpi-value">'+pct(top3sum, Math.max(1,noVentas))+'%</div><div class="kpi-subtitle">Top 3 motivos / no ventas</div></div>';

  // Campa√±a con mayor concentraci√≥n de motivo (riesgo de script espec√≠fico)
  html += '<div class="kpi-card"><div class="kpi-label">Campa√±a m√°s ‚Äúconcentrada‚Äù</div><div class="kpi-value">'+(function(){
      var best = {c:'‚Äî', v:-1, label:''};
      Object.keys(campTopMotivoShare).forEach(function(c){
        var o = campTopMotivoShare[c];
        if(o.total >= 5 && o.pct > best.v){ best = {c:c, v:o.pct, label:o.label}; }
      });
      return best.v < 0 ? '‚Äî' : (best.c + ' ('+pct0to100(best.v)+'%)');
    })()+'</div><div class="kpi-subtitle">Top motivo domina la no venta</div></div>';

  html += '</div></div>';

  // CONTROL (Responsabilidad + data)
  html += '<div class="kpis-section"><div class="kpis-section-title">Control de gesti√≥n (qu√© depende del agente y calidad de registro)</div><div class="kpis-grid">';

  // Share Agente en No Venta
  var agenteNoVenta = 0, respNoVentaTotal = 0;
  Object.keys(campStats).forEach(function(c){
    agenteNoVenta += campStats[c].respAgenteNoVenta;
    respNoVentaTotal += campStats[c].respTotalNoVenta;
  });
  var agenteShare = respNoVentaTotal ? (agenteNoVenta/respNoVentaTotal) : 0;
  html += '<div class="kpi-card"><div class="kpi-label">% No venta atribuible al Agente</div><div class="kpi-value">'+pct0to100(agenteShare)+'%</div><div class="kpi-subtitle">Sobre no ventas con responsabilidad informada</div></div>';

  html += '<div class="kpi-card"><div class="kpi-label">Cobertura de Motivo (No venta)</div><div class="kpi-value">'+pct0to100(motivoFillPct)+'%</div><div class="kpi-subtitle">'+motivoFilled+' de '+noVentas+' no ventas</div></div>';

  html += '<div class="kpi-card"><div class="kpi-label">NA en habilidades</div><div class="kpi-value">'+pct0to100(skillNApct)+'%</div><div class="kpi-subtitle">Mientras m√°s bajo, mejor calidad</div></div>';

  html += '<div class="kpi-card"><div class="kpi-label">Cobertura de Responsabilidad</div><div class="kpi-value">'+pct0to100(respFillPct)+'%</div><div class="kpi-subtitle">'+respFilled+' de '+noVentas+' no ventas</div></div>';

  html += '</div></div>';

  // Tabla corta / narrativa por campa√±a
  var campRows = Object.keys(campStats)
    .map(function(c){
      var st = campStats[c];
      return {
        c:c,
        total: st.total,
        conv: st.total ? (st.venta/st.total) : 0,
        exec: st.execValid ? (st.execYes/st.execValid) : 0,
        agente: st.respTotalNoVenta ? (st.respAgenteNoVenta/st.respTotalNoVenta) : 0,
        topMot: (campTopMotivoShare[c] ? campTopMotivoShare[c].label : 'NA'),
        topMotPct: (campTopMotivoShare[c] ? campTopMotivoShare[c].pct : 0)
      };
    })
    .sort(function(a,b){ return b.conv - a.conv; });

  var campHtml = '<div class="kpis-section"><div class="kpis-section-title">Scoreboard por campa√±a (Deepening / Pr√©stamos / Tarjetas)</div>';
  campHtml += '<div style="overflow:auto;">';
  campHtml += '<table style="width:100%; border-collapse:collapse; font-size:13px;">';
  campHtml += '<thead><tr>'
    + '<th style="text-align:left; padding:10px; border-bottom:1px solid var(--color-border);">Campa√±a</th>'
    + '<th style="text-align:right; padding:10px; border-bottom:1px solid var(--color-border);">Muestra</th>'
    + '<th style="text-align:right; padding:10px; border-bottom:1px solid var(--color-border);">Conversi√≥n</th>'
    + '<th style="text-align:right; padding:10px; border-bottom:1px solid var(--color-border);">Ejecuci√≥n speech</th>'
    + '<th style="text-align:right; padding:10px; border-bottom:1px solid var(--color-border);">% Agente (No venta)</th>'
    + '<th style="text-align:left; padding:10px; border-bottom:1px solid var(--color-border);">Top motivo</th>'
    + '<th style="text-align:right; padding:10px; border-bottom:1px solid var(--color-border);">Peso Top motivo</th>'
    + '</tr></thead><tbody>';

  campRows.forEach(function(r){
    campHtml += '<tr>'
      + '<td style="padding:10px; border-bottom:1px solid var(--color-border); font-weight:700;">'+r.c+'</td>'
      + '<td style="padding:10px; border-bottom:1px solid var(--color-border); text-align:right;">'+r.total+'</td>'
      + '<td style="padding:10px; border-bottom:1px solid var(--color-border); text-align:right;">'+pct0to100(r.conv)+'%</td>'
      + '<td style="padding:10px; border-bottom:1px solid var(--color-border); text-align:right;">'+pct0to100(r.exec)+'%</td>'
      + '<td style="padding:10px; border-bottom:1px solid var(--color-border); text-align:right;">'+pct0to100(r.agente)+'%</td>'
      + '<td style="padding:10px; border-bottom:1px solid var(--color-border);">'+(r.topMot||'NA')+'</td>'
      + '<td style="padding:10px; border-bottom:1px solid var(--color-border); text-align:right;">'+pct0to100(r.topMotPct)+'%</td>'
      + '</tr>';
  });

  campHtml += '</tbody></table></div></div>';

  kpiBox.innerHTML = html + campHtml;

  // === Narrative accionable ===
  var bestCamp = campRows.length ? campRows[0] : null;
  var worstCamp = campRows.length ? campRows[campRows.length-1] : null;

  var parts = [];
  parts.push('<div style="padding:12px; border:1px solid var(--color-border); border-radius:10px; background: var(--color-background);">'
    + '<div style="font-weight:800; margin-bottom:6px;">Lectura r√°pida</div>'
    + '<ul style="margin:0; padding-left:18px;">'
    + '<li>Conversi√≥n global: <b>'+pct(ventas,total)+'%</b> (Ventas: '+ventas+' / '+total+').</li>'
    + (bestCamp ? '<li>Mejor campa√±a: '+bestCamp.c+' con '+pct0to100(bestCamp.conv)+'% de conversi√≥n (muestra '+bestCamp.total+').</li>' : '')
    + (worstCamp ? '<li>Campa√±a con oportunidad: '+worstCamp.c+' con '+pct0to100(worstCamp.conv)+'% de conversi√≥n.</li>' : '')
    + (topMotivo ? '<li>Principal freno en no venta: "'+topMotivo.k+'" ('+pct(topMotivo.v, Math.max(1,noVentas))+'% de no ventas).</li>' : '<li>No hay motivos suficientes registrados.</li>')
    + (topSkill ? '<li>Principal brecha entrenable: '+topSkill.k+' ('+pct(topSkill.v,total)+'% de auditor√≠as con NO).</li>' : '<li>No hay datos suficientes de habilidades para brechas.</li>')
    + '</ul></div>'
  );

  parts.push('<div style="margin-top:12px; padding:12px; border:1px solid var(--color-border); border-radius:10px; background: var(--color-surface);">'
    + '<div style="font-weight:800; margin-bottom:6px;">Acciones sugeridas (operativo + coaching)</div>'
    + '<ul style="margin:0; padding-left:18px;">'
    + '<li>Crear 1 micro-plan por campa√±a: 1 objeci√≥n top + 1 habilidad top + 1 m√©trica objetivo semanal.</li>'
    + '<li>Si Cierre tiene alto NO, aplicar rutina: ‚Äúpregunta de avance‚Äù + ‚Äúbeneficio‚Äù + ‚Äúcierre directo‚Äù + ‚Äúbaja‚Äù.</li>'
    + '<li>Si el Top motivo domina una campa√±a (&gt;35%), dise√±ar un script espec√≠fico para esa objeci√≥n y auditar impacto.</li>'
    + '<li>Reducir NA en habilidades: exigir que auditor√≠as tengan SI/NO para al menos 4 de 6 skills.</li>'
    + '</ul></div>'
  );

  narrative.innerHTML = parts.join('');

  // === Charts ===
  destroyAnalysisCharts();

  // Chart 1: Top motivos global
  var c1 = document.getElementById('analysisChart1');
  if(c1 && topMotivos.length && typeof Chart !== 'undefined'){
    var labels1 = topMotivos.map(function(x){ return (x.k.length>28)?(x.k.slice(0,28)+'‚Ä¶'):x.k; });
    var data1 = topMotivos.map(function(x){ return x.v; });
    analysisChartInstances.push(new Chart(c1, {
      type: 'bar',
      data: { labels: labels1, datasets: [{ label:'No ventas', data: data1, backgroundColor:'#FF6B6B' }] },
      options: { responsive:true, plugins:{ title:{ display:true, text:'Top motivos de rechazo (No Venta)' }, legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
    }));
  }

  // Chart 2: Quiebres (NO) por habilidad
  var c2 = document.getElementById('analysisChart2');
  if(c2 && topSkills.length && typeof Chart !== 'undefined'){
    var labels2 = topSkills.map(function(x){ return x.k; });
    var data2 = topSkills.map(function(x){ return x.v; });
    analysisChartInstances.push(new Chart(c2, {
      type: 'bar',
      data: { labels: labels2, datasets: [{ label:'Quiebres (NO)', data: data2, backgroundColor:'#32B8C6' }] },
      options: { responsive:true, plugins:{ title:{ display:true, text:'Brechas comerciales (quiebres)' }, legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
    }));
  }

  // Chart 3: Conversi√≥n por campa√±a
  var c3 = document.getElementById('analysisChart3');
  if(c3 && typeof Chart !== 'undefined'){
    var campLabels = Object.keys(campStats).sort();
    var data3 = campLabels.map(function(c){
      var st = campStats[c];
      return st.total ? pct0to100(st.venta/st.total) : 0;
    });
    analysisChartInstances.push(new Chart(c3, {
      type: 'bar',
      data: { labels: campLabels, datasets: [{ label:'% Conversi√≥n', data: data3, backgroundColor:'#00C49F' }] },
      options: { responsive:true, plugins:{ title:{ display:true, text:'Conversi√≥n por campa√±a (% Venta)' }, legend:{ display:false } }, scales:{ y:{ beginAtZero:true, max:100 } } }
    }));
  }

  // Chart 4: Ejecuci√≥n speech por campa√±a
  var c4 = document.getElementById('analysisChart4');
  if(c4 && typeof Chart !== 'undefined'){
    var campLabels4 = Object.keys(campStats).sort();
    var data4 = campLabels4.map(function(c){
      var st = campStats[c];
      return st.execValid ? pct0to100(st.execYes/st.execValid) : 0;
    });
    analysisChartInstances.push(new Chart(c4, {
      type: 'bar',
      data: { labels: campLabels4, datasets: [{ label:'% Ejecuci√≥n', data: data4, backgroundColor:'#3B82F6' }] },
      options: { responsive:true, plugins:{ title:{ display:true, text:'√çndice de ejecuci√≥n del speech por campa√±a' }, legend:{ display:false } }, scales:{ y:{ beginAtZero:true, max:100 } } }
    }));
  }

  // Chart 5: % Agente en No venta por campa√±a
  var c5 = document.getElementById('analysisChart5');
  if(c5 && typeof Chart !== 'undefined'){
    var campLabels5 = Object.keys(campStats).sort();
    var data5 = campLabels5.map(function(c){
      var st = campStats[c];
      return st.respTotalNoVenta ? pct0to100(st.respAgenteNoVenta/st.respTotalNoVenta) : 0;
    });
    analysisChartInstances.push(new Chart(c5, {
      type: 'bar',
      data: { labels: campLabels5, datasets: [{ label:'% Agente', data: data5, backgroundColor:'#F59E0B' }] },
      options: { responsive:true, plugins:{ title:{ display:true, text:'% No venta atribuible al Agente (por campa√±a)' }, legend:{ display:false } }, scales:{ y:{ beginAtZero:true, max:100 } } }
    }));
  }

  // Chart 6: Peso del Top motivo por campa√±a
  var c6 = document.getElementById('analysisChart6');
  if(c6 && typeof Chart !== 'undefined'){
    var campLabels6 = Object.keys(campTopMotivoShare).sort();
    var data6 = campLabels6.map(function(c){ return pct0to100(campTopMotivoShare[c].pct); });
    analysisChartInstances.push(new Chart(c6, {
      type: 'bar',
      data: { labels: campLabels6, datasets: [{ label:'% Top motivo', data: data6, backgroundColor:'#EF4444' }] },
      options: { responsive:true, plugins:{ title:{ display:true, text:'Concentraci√≥n del Top motivo (No venta) por campa√±a' }, legend:{ display:false } }, scales:{ y:{ beginAtZero:true, max:100 } } }
    }));
  }
}


// Hook seguro: al entrar al tab An√°lisis, renderiza.
// (No reemplaza tu switchTab; lo envuelve.)
if (typeof window.switchTab === 'function') {
  (function(){
    var _sw = window.switchTab;
    window.switchTab = function(tabName){
      var res = _sw.apply(this, arguments);
      // pinta An√°lisis cuando el DOM ya activ√≥ la pesta√±a
      if(tabName === 'analisis'){
        setTimeout(function(){
          try{ renderAnalysis(); }catch(e){}
        }, 120);
      }
      return res;
    }
  })();
}

// Hook seguro: cuando termina de cargar data desde Sheets, repinta si est√°s parado en An√°lisis.
if (typeof window.loadDataFromGoogleSheets === 'function') {
  (function(){
    var _ld = window.loadDataFromGoogleSheets;
    window.loadDataFromGoogleSheets = function(){
      var res = _ld.apply(this, arguments);
      setTimeout(function(){
        try {
          var active = document.querySelector('.tab-content.active');
          if(active && active.id === 'analisis') renderAnalysis();
        } catch(e) {}
      }, 200);
      return res;
    }
  })();
}


// =====================
// LOGIN (m√°scara UI) + ROLES B√ÅSICOS
// =====================
var USER_DB = [
  // Edita aqu√≠ tus usuarios y contrase√±as (m√°scara visual)
  // role: 'calidad' => solo Gesti√≥n Calidad
  // role: 'operaciones' => Dashboard + Feedback + An√°lisis
  { user: 'qa01', pass: 'Calidad2025', role: 'calidad', name: 'Calidad' },
  { user: 'ops01', pass: 'Operaciones2025', role: 'operaciones', name: 'Operaciones' }
];

function toggleLoginHelp(){
  var h = document.getElementById('loginHelp');
  if(!h) return;
  h.style.display = (h.style.display === 'none' || !h.style.display) ? 'block' : 'none';
}

function showLoginMsg(msg){
  var box = document.getElementById('loginMsg');
  if(!box) return;
  box.style.display = 'block';
  box.textContent = msg;
}

function hideLoginOverlay(){
  var ov = document.getElementById('loginOverlay');
  if(ov) ov.classList.add('hidden');
}

function showLoginOverlay(){
  var ov = document.getElementById('loginOverlay');
  if(ov) ov.classList.remove('hidden');
}

function setSessionUser(u){
  sessionStorage.setItem('auth_user', u.user);
  sessionStorage.setItem('auth_role', u.role);
  sessionStorage.setItem('auth_name', u.name || u.user);
}

function clearSessionUser(){
  sessionStorage.removeItem('auth_user');
  sessionStorage.removeItem('auth_role');
  sessionStorage.removeItem('auth_name');
}

function getSessionRole(){
  return sessionStorage.getItem('auth_role') || '';
}

function applyRoleUI(){
  var role = getSessionRole();

  var btnDash = document.querySelector('.sidebar-link[data-tab="dashboard"]');
  var btnFeed = document.querySelector('.sidebar-link[data-tab="feedback"]');
  var btnAna  = document.querySelector('.sidebar-link[data-tab="analisis"]');
  var btnGes  = document.querySelector('.sidebar-link[data-tab="gestion"]');

  function setBtn(btn, show){
    if(!btn) return;
    btn.style.display = show ? '' : 'none';
  }

  if(!role){
    setBtn(btnDash, false); setBtn(btnFeed, false); setBtn(btnAna, false); setBtn(btnGes, false);
    return;
  }

  if(role === 'calidad'){
    setBtn(btnGes, true);
    setBtn(btnDash, false);
    setBtn(btnFeed, false);
    setBtn(btnAna, false);
    try{ switchTab('gestion'); }catch(e){}
  } else {
    // operaciones (default)
    setBtn(btnGes, false);
    setBtn(btnDash, true);
    setBtn(btnFeed, true);
    setBtn(btnAna, true);
    try{ switchTab('dashboard'); }catch(e){}
  }
}

function guardTabAccess(tabName){
  var role = getSessionRole();
  if(!role) return false;
  if(role === 'calidad') return tabName === 'gestion';
  if(role === 'operaciones') return (tabName === 'dashboard' || tabName === 'feedback' || tabName === 'analisis');
  return false;
}

function handleLogin(){
  var u = (document.getElementById('loginUser')||{}).value || '';
  var p = (document.getElementById('loginPass')||{}).value || '';
  u = u.trim();

  var found = USER_DB.find(function(x){ return x.user === u && x.pass === p; });
  if(!found){
    showLoginMsg('Usuario o contrase√±a incorrectos.');
    return;
  }

  setSessionUser(found);
  hideLoginOverlay();
  applyRoleUI();
}

function logout(){
  clearSessionUser();
  showLoginOverlay();
  applyRoleUI();
}

// Envuelve switchTab para bloquear accesos directos
if (typeof window.switchTab === 'function') {
  (function(){
    var _sw = window.switchTab;
    window.switchTab = function(tabName){
      if(!guardTabAccess(tabName)){
        try{ showLoginOverlay(); }catch(e){}
        return;
      }
      return _sw.apply(this, arguments);
    }
  })();
}

document.addEventListener('DOMContentLoaded', function(){
  // bot√≥n logout (si no existe, no hace nada)
  applyRoleUI();
  showLoginOverlay();

  // Enter para ingresar
  var pass = document.getElementById('loginPass');
  if(pass){
    pass.addEventListener('keydown', function(e){
      if(e.key === 'Enter') handleLogin();
    });
  }

  // Si ya hab√≠a sesi√≥n abierta (misma pesta√±a), respeta.
  if(getSessionRole()){
    hideLoginOverlay();
    applyRoleUI();
  }
});
</script>
  </main>
</div>
